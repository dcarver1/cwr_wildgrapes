## Geographic representativeness score insitu
grs_insitu1 <- GRSin(taxon = i, sdm = sdm, protectedAreas = protectedAreas)
## ecological representativeness score insitu
ers_insitu1 <- ERSin(
taxon = i,
sdm = sdm,
occurrenceData = occurrenceData,
protectedAreas = protectedAreas,
ecoregions = ecoregions,
idColumn = "ECO_CODE",
limitByPoints = TRUE
)
## final representativeness score insitu
fcs_insitu1 <- FCSin(
taxon = i,
srsin = srs_insitu1,
grsin = grs_insitu1,
ersin = ers_insitu1
)
## combine conservation score
fcs_combine1 <- FCSc_mean(taxon = i, fcsin = fcs_insitu1, fcsex = fcs_exsitu1)
write_csv(x = fcs_combine, file = export)
} else {
fcs_combine <- read_csv(export)
}
fcs_combine1
# test some options
i <- "Vitis arizonica"
n <- 1
export <- paste0("data/Vitis/varBuffer/", i, "_", bs, "includePoints.csv")
if (!file.exists(export)) {
print(i)
rs <- r2[grepl(pattern = paste0(i, "/"), x = r2)]
if (length(rs) == 0) {
next
}
sdm <- rast(rs)
sdm[sdm == 0, ] <- NA
p1 <- sf::st_read(s2[grepl(pattern = paste0(i,"/"), x = s2) ])
occurrenceData <- p1 |>
as.data.frame() |>
dplyr::select(
species= taxon,  latitude, longitude, type
)
# p1 <- vect(s2[grepl(pattern = paste0(i, "/"), x = s2)])
# limit ecoregions to the areas with known occurrences
# eco1 <- ecoregions[p1, ]
# occurrenceData is used for srsex
srs_exsitu1 <- SRSex(
taxon = i,
occurrence_Data = occurrenceData1
)
# same
# need to use the spatial data as this is watch was evaluated within the model
# spatialData <- as.data.frame(p1) |>
#   dplyr::select(
#     species = taxon,
#     latitude,
#     longitude,
#     type
#   )
# testing
## Generate buffer objects
gBuffer <- generateGBuffers(
taxon = i,
occurrenceData = occurrenceData,
bufferDistM = buffSize
)
## geographic representativeness score  exsitu
grs_exsitu1 <- GRSex(taxon = i,
sdm = sdm,
gBuffer = gBuffer)
## map is not clipping the buffer objects to the distribution
## Ecological representativeness score exsitu
ers_exsitu1 <- ERSex(
taxon = i,
sdm = sdm,
occurrenceData = occurrenceData,
gBuffer = gBuffer,
ecoregions = ecoregions,
idColumn = "ECO_ID_U",
limitByPoints = TRUE
)
# Running final conservation score ecoregionsexsitu
fcs_exsitu1 <- FCSex(
taxon = i,
srsex = srs_exsitu1,
grsex = grs_exsitu1,
ersex = ers_exsitu1
)
# generate insitu conservation summaries
## sample representativeness score insitu
srs_insitu1 <- SRSin(
taxon = i,
sdm = sdm,
occurrenceData = occurrenceData,
protectedAreas = protectedAreas
)
## Geographic representativeness score insitu
grs_insitu1 <- GRSin(taxon = i, sdm = sdm, protectedAreas = protectedAreas)
## ecological representativeness score insitu
ers_insitu1 <- ERSin(
taxon = i,
sdm = sdm,
occurrenceData = occurrenceData,
protectedAreas = protectedAreas,
ecoregions = ecoregions,
idColumn = "ECO_CODE",
limitByPoints = TRUE
)
## final representativeness score insitu
fcs_insitu1 <- FCSin(
taxon = i,
srsin = srs_insitu1,
grsin = grs_insitu1,
ersin = ers_insitu1
)
## combine conservation score
fcs_combine1 <- FCSc_mean(taxon = i, fcsin = fcs_insitu1, fcsex = fcs_exsitu1)
write_csv(x = fcs_combine, file = export)
} else {
fcs_combine <- read_csv(export)
}
fcs_combine1
fcs_combine
output <- fcs_combine1
output
# join the data and export
s1 <- list.files("data/Vitis/varBuffer/",
pattern = "summaryTable",
full.names = TRUE) |>
read_csv() |>
dplyr::mutate(
bufferSize = c(
rep("10k", 35),
rep("100k", 35),
rep("50k", 35)
)
)
# rerun
pacman::p_load(terra, dplyr, readr, leaflet, remotes)
# remotes::install_git("https://github.com/CIAT-DAPA/GapAnalysis",ref = "updateERS" )
# sourcing directly for the file storage
list.files("~/trueNAS/work/GapAnalysis/R",
full.names = TRUE
) |>
lapply(FUN = source)
# load in ecoregion and protect areas data
## ecoregions
ecoregions <- sf::st_read(
"data/geospatial_datasets/ecoregions/tnc_terr_ecoregions.gpkg"
) |>
terra::vect()
## protect lands
protectedAreas <- terra::rast(
"data/geospatial_datasets/protectedLands/wdpa_1km_all_.tif"
)
# gather data
runVersion <- "run08282025_1k"
files <- list.files(path = "data/Vitis", full.names = TRUE, recursive = TRUE)
r1 <- files[grepl(pattern = runVersion, x = files)]
# load in all rasters
r2 <- r1[grepl(pattern = "prj_threshold.tif", x = r1)]
# load in data for species
s2 <- r1[grepl(pattern = "spatialData.gpkg", x = r1)]
speciesData <- read_csv("temp/allVitisData082025.csv")
species <- sort(unique(speciesData$taxon))
# org for gap r
occurrenceData1 <- speciesData |>
dplyr::select(
species = taxon,
latitude,
longitude,
type
)
buffSize <- 50000
# test some options
i <- "Vitis arizonica"
i <- "Vitis bloodworthiana"
# join the data and export
s1 <- list.files("data/Vitis/varBuffer/",
pattern = "summaryTable",
full.names = TRUE) |>
read_csv() |>
dplyr::mutate(
bufferSize = c(
rep("10k", 35),
rep("100k", 35),
rep("50k", 35)
)
)
# join the data and export
s1 <- list.files("data/Vitis/varBuffer/",
pattern = "summaryTable",
full.names = TRUE) |>
read_csv()
s1
# join the data and export
s1 <- list.files("data/Vitis/varBuffer/",
pattern = "summaryTable",
full.names = TRUE)
s1
# join the data and export
s1 <- list.files("data/Vitis/varBuffer/",
pattern = "includePoints",
full.names = TRUE)
# join the data and export
s1 <- list.files("data/Vitis/varBuffer/",
pattern = "includePoints",
full.names = TRUE) |>
read_csv()
# join the data and export
s1 <- list.files("data/Vitis/varBuffer/",
pattern = "includePoints",
full.names = TRUE) |>
read_csv() |>dplyr::mutate(
bufferSize = c(
rep("10k", 35),
rep("100k", 35),
rep("50k", 35)
)
)
s1
dim(s1)
bufferSize = c(
rep("10k", 35),
rep("100k", 35),
rep("50k", 35)
)
length(    bufferSize = c(
rep("10k", 35),
rep("100k", 35),
rep("50k", 35)
))
length(bufferSize)
s1$Taxon
s1 |>
dplyr::group_by(taxon)|>
count()
# join the data and export
s1 <- list.files("data/Vitis/varBuffer/",
pattern = "includePoints",
full.names = TRUE) |>
read_csv()
s1
s1 |> group_by(Taxon) |> count()
test1 <- s1 |> group_by(Taxon) |> count()
View(test1)
# rerun
pacman::p_load(terra, dplyr, readr, leaflet, remotes)
# remotes::install_git("https://github.com/CIAT-DAPA/GapAnalysis",ref = "updateERS" )
# sourcing directly for the file storage
list.files("~/trueNAS/work/GapAnalysis/R",
full.names = TRUE
) |>
lapply(FUN = source)
# load in ecoregion and protect areas data
## ecoregions
ecoregions <- sf::st_read(
"data/geospatial_datasets/ecoregions/tnc_terr_ecoregions.gpkg"
) |>
terra::vect()
## protect lands
protectedAreas <- terra::rast(
"data/geospatial_datasets/protectedLands/wdpa_1km_all_.tif"
)
# gather data
runVersion <- "run08282025_1k"
files <- list.files(path = "data/Vitis", full.names = TRUE, recursive = TRUE)
r1 <- files[grepl(pattern = runVersion, x = files)]
# load in all rasters
r2 <- r1[grepl(pattern = "prj_threshold.tif", x = r1)]
# load in data for species
s2 <- r1[grepl(pattern = "spatialData.gpkg", x = r1)]
speciesData <- read_csv("temp/allVitisData082025.csv")
species <- sort(unique(speciesData$taxon))
# org for gap r
occurrenceData1 <- speciesData |>
dplyr::select(
species = taxon,
latitude,
longitude,
type
)
buffSize <- 50000
for(bs in c(10000,50000,100000)){
n <- 1
for (i in species) {
export <- paste0("data/Vitis/varBuffer/", i, "_", bs, "includePoints.csv")
if (!file.exists(export)) {
print(i)
rs <- r2[grepl(pattern = paste0(i, "/"), x = r2)]
if (length(rs) == 0) {
next
}
sdm <- rast(rs)
sdm[sdm == 0, ] <- NA
p1 <- sf::st_read(s2[grepl(pattern = paste0(i,"/"), x = s2) ])
occurrenceData <- p1 |>
as.data.frame() |>
dplyr::select(
species= taxon,  latitude, longitude, type
)
# p1 <- vect(s2[grepl(pattern = paste0(i, "/"), x = s2)])
# limit ecoregions to the areas with known occurrences
# eco1 <- ecoregions[p1, ]
# occurrenceData is used for srsex
srs_exsitu1 <- SRSex(
taxon = i,
occurrence_Data = occurrenceData1
)
# same
# need to use the spatial data as this is watch was evaluated within the model
# spatialData <- as.data.frame(p1) |>
#   dplyr::select(
#     species = taxon,
#     latitude,
#     longitude,
#     type
#   )
# testing
## Generate buffer objects
gBuffer <- generateGBuffers(
taxon = i,
occurrenceData = occurrenceData,
bufferDistM = buffSize
)
## geographic representativeness score  exsitu
grs_exsitu1 <- GRSex(taxon = i,
sdm = sdm,
gBuffer = gBuffer)
## map is not clipping the buffer objects to the distribution
## Ecological representativeness score exsitu
ers_exsitu1 <- ERSex(
taxon = i,
sdm = sdm,
occurrenceData = occurrenceData,
gBuffer = gBuffer,
ecoregions = ecoregions,
idColumn = "ECO_ID_U",
limitByPoints = TRUE
)
# Running final conservation score ecoregionsexsitu
fcs_exsitu1 <- FCSex(
taxon = i,
srsex = srs_exsitu1,
grsex = grs_exsitu1,
ersex = ers_exsitu1
)
# generate insitu conservation summaries
## sample representativeness score insitu
srs_insitu1 <- SRSin(
taxon = i,
sdm = sdm,
occurrenceData = occurrenceData,
protectedAreas = protectedAreas
)
## Geographic representativeness score insitu
grs_insitu1 <- GRSin(taxon = i, sdm = sdm, protectedAreas = protectedAreas)
## ecological representativeness score insitu
ers_insitu1 <- ERSin(
taxon = i,
sdm = sdm,
occurrenceData = occurrenceData,
protectedAreas = protectedAreas,
ecoregions = ecoregions,
idColumn = "ECO_CODE",
limitByPoints = TRUE
)
## final representativeness score insitu
fcs_insitu1 <- FCSin(
taxon = i,
srsin = srs_insitu1,
grsin = grs_insitu1,
ersin = ers_insitu1
)
## combine conservation score
fcs_combine1 <- FCSc_mean(taxon = i, fcsin = fcs_insitu1, fcsex = fcs_exsitu1)
write_csv(x = fcs_combine1, file = export)
} else {
fcs_combine1 <- read_csv(export)
}
if (n == 1) {
output <- fcs_combine1
} else {
output <- bind_rows(output, fcs_combine1)
}
n = n + 1
}
write_csv(x = output, file = paste0("data/Vitis/varBuffer/summaryTable_",bs,"inlcudePoints.csv" ))
}
# join the data and export
s1 <- list.files("data/Vitis/varBuffer/",
pattern = "includePoints",
full.names = TRUE) |>
read_csv()
s1
# join the data and export
s1 <- list.files("data/Vitis/varBuffer/",
pattern = "includePoints",
full.names = TRUE) |>
read_csv() |>dplyr::mutate(
bufferSize = c(
rep("10k", 35),
rep("100k", 35),
rep("50k", 35)
)
)
write_csv(s1, "data/Vitis/varBuffer/full_set_2025-11-10.csv")
i
for (i in species) {
export <- paste0("data/Vitis/varBuffer/", i, "_", bs, "includePoints.csv")
if (!file.exists(export)) {
print(i)
rs <- r2[grepl(pattern = paste0(i, "/"), x = r2)]
if (length(rs) == 0) {
next
}
sdm <- rast(rs)
sdm[sdm == 0, ] <- NA
p1 <- sf::st_read(s2[grepl(pattern = paste0(i,"/"), x = s2) ])
occurrenceData <- p1 |>
as.data.frame() |>
dplyr::select(
species= taxon,  latitude, longitude, type
)
# p1 <- vect(s2[grepl(pattern = paste0(i, "/"), x = s2)])
# limit ecoregions to the areas with known occurrences
# eco1 <- ecoregions[p1, ]
# occurrenceData is used for srsex
srs_exsitu1 <- SRSex(
taxon = i,
occurrence_Data = occurrenceData1
)
# same
# need to use the spatial data as this is watch was evaluated within the model
# spatialData <- as.data.frame(p1) |>
#   dplyr::select(
#     species = taxon,
#     latitude,
#     longitude,
#     type
#   )
# testing
## Generate buffer objects
gBuffer <- generateGBuffers(
taxon = i,
occurrenceData = occurrenceData,
bufferDistM = bs
)
## geographic representativeness score  exsitu
grs_exsitu1 <- GRSex(taxon = i,
sdm = sdm,
gBuffer = gBuffer)
## map is not clipping the buffer objects to the distribution
## Ecological representativeness score exsitu
ers_exsitu1 <- ERSex(
taxon = i,
sdm = sdm,
occurrenceData = occurrenceData,
gBuffer = gBuffer,
ecoregions = ecoregions,
idColumn = "ECO_ID_U",
limitByPoints = TRUE
)
# Running final conservation score ecoregionsexsitu
fcs_exsitu1 <- FCSex(
taxon = i,
srsex = srs_exsitu1,
grsex = grs_exsitu1,
ersex = ers_exsitu1
)
# generate insitu conservation summaries
## sample representativeness score insitu
srs_insitu1 <- SRSin(
taxon = i,
sdm = sdm,
occurrenceData = occurrenceData,
protectedAreas = protectedAreas
)
## Geographic representativeness score insitu
grs_insitu1 <- GRSin(taxon = i, sdm = sdm, protectedAreas = protectedAreas)
## ecological representativeness score insitu
ers_insitu1 <- ERSin(
taxon = i,
sdm = sdm,
occurrenceData = occurrenceData,
protectedAreas = protectedAreas,
ecoregions = ecoregions,
idColumn = "ECO_CODE",
limitByPoints = TRUE
)
## final representativeness score insitu
fcs_insitu1 <- FCSin(
taxon = i,
srsin = srs_insitu1,
grsin = grs_insitu1,
ersin = ers_insitu1
)
## combine conservation score
fcs_combine1 <- FCSc_mean(taxon = i, fcsin = fcs_insitu1, fcsex = fcs_exsitu1)
write_csv(x = fcs_combine1, file = export)
} else {
fcs_combine1 <- read_csv(export)
}
if (n == 1) {
output <- fcs_combine1
} else {
output <- bind_rows(output, fcs_combine1)
}
n = n + 1
}
