modelDataSummary <- data.frame(
species = j,
presenceRecords = nrow(m_data[m_data$presence == 1, ]),
backgroudRecords = nrow(m_data[m_data$presence == 0, ]),
totalRecords = nrow(m_data)
)
write_csv(
x = modelDataSummary,
file = paste0(allPaths$occurances, "/modelDataSummary.csv")
)
## perform variable selection
v_data <- write_RDS(
path = allPaths$variablbeSelectPath,
overwrite = overwrite,
function1 = varaibleSelection(modelData = m_data, parallel = TRUE)
)
## prepare data for maxent model
rasterInputs <- write_Rast(
path = allPaths$prepRasters,
overwrite = overwrite,
function1 = cropRasters(
natArea = natArea,
bioVars = bioVars,
selectVars = v_data
)
)
## perform maxent model
### tabular data
sdm_results <- write_RDS(
path = allPaths$sdmResults,
overwrite = overwrite,
function1 = runMaxnet(selectVars = v_data, rasterData = rasterInputs)
)
## condition to test if model was suscessfull produced.
if (!is.null(sdm_results)) {
print("conservation metrics")
## raster objects
projectsResults <- write_RDS(
path = allPaths$modeledRasters,
overwrite = overwrite,
function1 = rasterResults(sdm_result)
)
## generate evaluationTable
evalTable <- write_CSV(
path = allPaths$evalTablePath,
overwrite = overwrite,
function1 = evaluateTable(sdm_result = sdm_results)
)
## generate threshold rasters
thres <- write_Rast(
path = allPaths$thresPath,
overwrite = overwrite,
function1 = generateThresholdModel(
evalTable = evalTable,
rasterResults = projectsResults
)
)
## crop GA50 to threshold area
g_bufferCrop <- write_Rast(
path = allPaths$g50_bufferPath,
overwrite = overwrite,
function1 = cropG_Buffer(ga50 = g_buffer, thres = thres)
)
# Gap Analysis Methods  ---------------------------------------------------
# insitu
## srsin
srsin <- write_CSV(
path = allPaths$srsinPath,
overwrite = overwrite,
function1 = srs_insitu(
occuranceData = sp1,
thres = thres,
protectedArea = protectedAreas
)
)
## ersin
ersin <- write_CSV(
path = allPaths$ersinPath,
overwrite = overwrite,
function1 = ers_insitu(
occuranceData = sp1,
nativeArea = natArea,
protectedArea = protectedAreas,
thres = thres,
rasterPath = allPaths$ersinRast
)
)
## grsin
grsin <- write_CSV(
path = allPaths$grsinPath,
overwrite = overwrite,
function1 = grs_insitu(
occuranceData = sp1,
protectedArea = protectedAreas,
thres = thres
)
)
## fcsin
fcsin <- write_CSV(
path = allPaths$fcsinPath,
overwrite = overwrite,
function1 = fcs_insitu(
srsin = srsin,
grsin = grsin,
ersin = ersin,
noModel = FALSE
)
)
#exsitu
##ersex
ersex <- write_CSV(
path = allPaths$ersexPath,
overwrite = TRUE,
function1 = ers_exsitu(
speciesData = sp1,
thres = thres,
natArea = natArea,
ga50 = g_bufferCrop,
rasterPath = allPaths$ersexRast
)
)
##grsex
grsex <- write_CSV(
path = allPaths$grsexPath,
overwrite = overwrite,
function1 = grs_exsitu(
speciesData = sp1,
ga50 = g_bufferCrop,
thres = thres
)
)
##fcsex
fcsex <- write_CSV(
path = allPaths$fcsexPath,
overwrite = TRUE,
function1 = fcs_exsitu(
srsex = srsex,
grsex = grsex,
ersex = ersex,
noModel = FALSE
)
)
#combined measure
fcsCombined <- write_CSV(
path = allPaths$fcsCombinedPath,
overwrite = TRUE,
function1 = fcs_combine(fcsin = fcsin, fcsex = fcsex)
)
#gather features for RMD
## just a helper function to reduce the number of input for the RMD
reportData <- write_RDS(
path = allPaths$summaryDataPath,
overwrite = TRUE,
function1 = grabData(
fscCombined = fcsCombined,
ersex = ersex,
ersin = ersin,
fcsex = fcsex,
fcsin = fcsin,
evalTable = evalTable,
g_bufferCrop = g_bufferCrop,
thres = thres,
projectsResults = projectsResults,
occuranceData = sp1,
v_data = v_data,
g_buffer = g_buffer,
natArea = natArea,
protectedAreas = protectedAreas,
countsData = c1,
variableImportance = allPaths$variablbeSelectPath,
NoModel = FALSE,
modelDataCounts = read_csv(paste0(
allPaths$occurances,
"/modelDataSummary.csv"
))
)
)
} else {
# no sdm results
#   erroredSpecies$noSDM <- c(erroredSpecies$noSDM, j)
#   print("conservation Metrics")
#   #Complete conservation assessments without models
#   ## srsin
#   srsin <- write_CSV(path = allPaths$srsinPath,
#                      overwrite = overwrite,
#                      function1 = srs_insitu(occuranceData = sp1,
#                                             thres = NA,
#                                             protectedArea =protectedAreas ))
#   ersin <- write_CSV(path = allPaths$ersinPath,
#                      overwrite = overwrite,
#                      function1 = ers_insitu(occuranceData = sp1,
#                                             nativeArea = natArea,
#                                             protectedArea = protectedAreas,
#                                             thres = thres,
#                                             rasterPath = allPaths$ersinRast))
#
#   ## grsin
#   grsin <-  write_CSV(path = allPaths$grsinPath,
#                       overwrite = overwrite ,
#                       function1 = grs_insitu(occuranceData = sp1,
#                                              protectedArea = protectedAreas,
#                                              thres = thres))
#
#
#   ## fcsin
#   fcsin <- write_CSV(path = allPaths$fcsinPath,
#                      overwrite = overwrite,
#                      function1 = fcs_insitu(srsin = srsin,
#                                             grsin = grsin,
#                                             ersin = ersin,
#                                             noModel = TRUE))
#
#
#   ##fcsex
#   fcsex <- write_CSV(path = allPaths$fcsexPath,
#                      overwrite = overwrite,
#                      function1 = fcs_exsitu(srsex = srsex,
#                                             grsex = grsex,
#                                             ersex = ersex,
#                                             noModel = TRUE))
#
#   #combined measure
#   fcsCombined <- write_CSV(path = allPaths$fcsCombinedPath,
#                            overwrite = overwrite,
#                            function1 = fcs_combine(fcsin = fcsin,
#                                                    fcsex = fcsex))
#   # generate report data for species
#   reportData <- write_RDS(path = allPaths$summaryDataPath,
#                           overwrite = overwrite,
#                           function1 = grabData(fscCombined = fcsCombined,
#                                                ersex = NA,
#                                                fcsex = fcsex,
#                                                fcsin = fcsin,
#                                                evalTable = NA,
#                                                g_bufferCrop = NA,
#                                                thres = NA,
#                                                 = NA,
#                                                occuranceData = sp1,
#                                                v_data = NA,
#                                                g_buffer = NA,
#                                                natArea = natArea,
#                                                protectedAreas = protectedAreas,
#                                                countsData = c1,
#                                                variableImportance = allPaths$variablbeSelectPath,
#                                                NoModel = TRUE))
#
}
} else {
# end of attempt to model
erroredSpecies$lessThenEight <- c(erroredSpecies$lessThenEight, j)
### need the FCS summary data for the full run summary
## srsin can be calculated for all species with at least one lat lon value
## if no model is present (GRSin and ERSin are NA)
## if no G points are present (srsex, grsex, and ersex are 0)
## if g Points present but no model (srsex is calculated, grsex, and ersex are NA )
# generating a buffer object to represent the threshold model
natAreaV <- terra::vect(natArea)
buffer <- sp1 |>
terra::vect() |>
terra::buffer(width = bufferDist) |>
terra::crop(natAreaV) |>
terra::mask(natAreaV)
# convert to a rast
rastBuff <- terra::crop(templateRast, buffer)
buffer_rs <- terra::rasterize(buffer, rastBuff)
names(buffer_rs) <- "Threshold"
# export this file to use in the full genus summary maps
write_Rast(buffer_rs, path = allPaths$thresPath, overwrite = overwrite)
# try to generate g buffer
g_buffer <- write_Rast(
path = allPaths$ga50Path,
overwrite = overwrite,
function1 = create_buffers(
speciesPoints = sp1,
natArea = natArea,
bufferDist = bufferDist,
templateRast = templateRast
)
)
if (class(g_buffer) == "character") {
g_bufferCrop <- g_buffer
} else {
g_bufferCrop <- g_buffer |> terra::mask(natAreaV)
# export this file to use in the full genus summary maps
write_Rast(g_buffer, path = allPaths$g50_bufferPath, overwrite = overwrite)
}
# pull n G points from
gPoints <- c1$totalGUseful
#
srsin <- write_CSV(
path = allPaths$srsinPath,
overwrite = overwrite,
function1 = srs_insitu(
occuranceData = sp1,
thres = buffer_rs,
protectedArea = protectedAreas
)
)
ersin <- write_CSV(
path = allPaths$ersinPath,
overwrite = overwrite,
function1 = ers_insitu(
occuranceData = sp1,
nativeArea = natArea,
protectedArea = protectedAreas,
thres = buffer_rs,
rasterPath = allPaths$ersinRast
)
)
## grsin
grsin <- write_CSV(
path = allPaths$grsinPath,
overwrite = overwrite,
function1 = grs_insitu(
occuranceData = sp1,
protectedArea = protectedAreas,
thres = buffer_rs
)
)
fcsin <- write_CSV(
path = allPaths$fcsinPath,
overwrite = overwrite,
function1 = fcs_insitu(
srsin = srsin,
grsin = grsin,
ersin = ersin,
noModel = FALSE
)
)
##ersex
ersex <- write_CSV(
path = allPaths$ersexPath,
overwrite = TRUE,
function1 = ers_exsitu(
speciesData = sd1,
thres = buffer_rs,
natArea = natArea,
ga50 = g_bufferCrop,
rasterPath = allPaths$ersexRast
)
)
##grsex
grsex <- write_CSV(
path = allPaths$grsexPath,
overwrite = TRUE,
function1 = grs_exsitu(
speciesData = sd1,
ga50 = g_bufferCrop,
thres = buffer_rs
)
)
##fcsex
fcsex <- write_CSV(
path = allPaths$fcsexPath,
overwrite = overwrite,
function1 = fcs_exsitu(
srsex = srsex,
grsex = grsex,
ersex = ersex,
noModel = FALSE,
gPoints = gPoints
)
)
#combined measure
fcsCombined <- write_CSV(
path = allPaths$fcsCombinedPath,
overwrite = overwrite,
function1 = fcs_combine(fcsin = fcsin, fcsex = fcsex)
)
reportData <- write_RDS(
path = allPaths$summaryDataPath,
overwrite = overwrite,
function1 = grabData(
fscCombined = fcsCombined,
ersex = ersex,
fcsex = fcsex,
fcsin = fcsin,
evalTable = NA,
g_bufferCrop = g_bufferCrop,
thres = buffer_rs,
projectsResults = NA,
occuranceData = sp1,
v_data = NA,
g_buffer = g_buffer,
natArea = natArea,
protectedAreas = protectedAreas,
countsData = c1,
variableImportance = NA,
NoModel = FALSE
)
)
# generate the report with
# rmarkdown::render(
#   input = "R2/summarize/singleSpeciesSummaryBuffer_1k.Rmd",
#   output_format = "html_document",
#   output_dir = p1, # file.path(allPaths$result),
#   output_file = paste0(j, "_Summary_fnaFilter"),
#   params = list(
#     reportData = reportData
#   ),
#   envir = new.env(parent = globalenv())
#   # clean = F,
#   # encoding = "utf-8"
# )
}
# generate summary html
# this is not working with the 1k data do to size fo the rasters... need to reevaluate
# rmd with Model ----------------------------------------------------------
htmlExport <- paste0(p1, "/", j, "_Summary_fnaFilter.html")
if(!file.exists(htmlExport)){
rmarkdown::render(
input = "R2/summarize/singleSpeciesSummary_1k.Rmd",
output_format = "html_document",
output_dir = p1, # file.path(allPaths$result),
output_file = paste0(j, "_Summary_fnaFilter"),
params = list(
reportData = reportData
),
envir = new.env(parent = globalenv())
# clean = F,
# encoding = "utf-8"
)
}
# # block here for testing. I want variable in local environment and don't want them written out.
# # stop()
#
# # remove all reused variables ---------------------------------------------
# rm(c1,sp1,srsex,natArea,g_buffer, ,evalTable,thres)
} # end of species loop
pacman::p_load(terra, dplyr, readr)
# testing
# gather the min max of the original data for a speicific locaiton
r17 <- terra::rast("~/trueNAS/work/northParkDune/data/raw/2017/blm_co_kfo_northsandcreek_dsm_3_1cm_westside.tif")
val17 <- minmax(r17)
val17
val17 <- minmax(r17, compute = TRUE)
val17
r25 <- terra::rast("~/trueNAS/work/northParkDune/data/raw/Alluvial Fan/NSH - Alluvial Fan_dsm.tif")
val25 <- minmax(r17, compute = TRUE)
val25 <- minmax(r25, compute = TRUE)
val25
genericCOT <- function(importPath,exportPath){
if (!file.exists(exportPath)) {
tryCatch(
{
raster_data <- terra::rast(importPath)
# 5b. Export the raster as a COG using the "COG" driver
terra::writeRaster(
x = raster_data,
filename = exportPath,
filetype = "COG", # Specify the Cloud Optimized GeoTIFF driver
gdal = cog_options, # Apply the COG creation options
overwrite = TRUE # Allows overwriting if you rerun the script
)
cat(paste0(
"SUCCESS: Exported as COG -> ",
basename(importPath),
"\n"
))
},
error = function(e) {
cat(paste0(
"ERROR processing ",
basename(importPath),
": ",
conditionMessage(e),
"\n"
))
}
)
} else {
cat(paste0("Skipping: ", importPath, " (COG already exists)\n"))
next
}
}
#source the COG function
source("functions/cog_functions.R")
# local testing
pacman::p_load(
"dplyr",
"sf",
"terra",
"purrr",
"randomForest",
"VSURF",
"modelr",
"maxnet",
"pROC",
"DT",
"readr",
"vroom",
"readr",
"dismo",
"leaflet",
"tidyterra",
"rmarkdown",
"furrr",
"stringr",
"spThin",
"tictoc",
"tigris",
"tmap",
"ggplot2",
"plotly",
"factoextra",
"tidyr",
"rnaturalearth"
)
## protect lands
protectedAreas <- terra::rast(
"data/geospatial_datasets/protectedLands/wdpa_1km_all_.tif"
)
