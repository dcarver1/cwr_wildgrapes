)
# apply FNA filter if possible.
sp1 <- write_GPKG(
path = allPaths$spatialDataPath,
overwrite = overwrite, # this needs to stay true otherwise the call above will be used.
function1 = applyFNA(
speciesPoints = sp1,
fnaData = fnaData,
states = naStates
)
)
## define natural area based on ecoregions
natArea <- write_GPKG(
path = allPaths$natAreaPath,
overwrite = overwrite,
function1 = nat_area_shp(speciesPoints = sp1, ecoregions = ecoregions)
)
## define number of background points
b_Number <- numberBackground(natArea = natArea)
# moved this data out of the modeling loop to capture new features
## associate observations with bioclim data and spatial thin
m_data1 <- write_CSV(
path = allPaths$allDataPath,
overwrite = FALSE,
generateModelData(
speciesPoints = sp1,
natArea = natArea,
bioVars = bioVars,
b_Number = b_Number
)
)
# exporting with type column now removing for consistenty
#
#   write_csv(
#     x = m_data1,
#     file = paste0(allPaths$allDataPath)
#   )
# next
# condition for at least 8 observations
## attempt to model the data
if (nrow(sp1) >= 8) {
print("Modeling")
## define number of background points
b_Number <- numberBackground(natArea = natArea)
## generate GA50 objects
g_buffer <- write_Rast(
path = allPaths$ga50Path,
overwrite = FALSE,
function1 = create_buffers(
speciesPoints = sp1,
natArea = natArea,
bufferDist = bufferDist,
templateRast = templateRast
)
)
# remove duplicated background data
m_data <- m_data1
presence <- m_data[m_data$presence == 1, ]
absence <- m_data[m_data$presence != 1, ]
dubs <- duplicated(absence[, 2:27])
absence <- absence[!dubs, ]
m_data <- bind_rows(presence, absence)
# write out the total data used in modeling effort
modelDataSummary <- data.frame(
species = j,
presenceRecords = nrow(m_data[m_data$presence == 1, ]),
backgroudRecords = nrow(m_data[m_data$presence == 0, ]),
totalRecords = nrow(m_data)
)
# write_csv(
#   x = modelDataSummary,
#   file = paste0(allPaths$occurances, "/modelDataSummary.csv")
# )
## perform variable selection
### something not working the export -- list object but not rendering with the write_RDS
v_data <- write_RDS(
path = allPaths$variablbeSelectPath,
overwrite = overwrite,
function1 = varaibleSelection(modelData = m_data, parallel = TRUE)
)
# had to re-export the variable selection data. I expect that I was attepting to write a list object as a csv
message(paste0("exporting model data with variables for ", j))
# # adding in a export for the variable selection data
write_csv(x = v_data$rankPredictors, file = paste0("data/Vitis/",j,"/run08282025_1k/occurances/topVariablesData.csv"))
# write_csv(x = v_data$rankPredictors, file = allPaths$allDataPath)
# next
## prepare data for maxent model
rasterInputs <- write_Rast(
path = allPaths$prepRasters,
overwrite = FALSE,
function1 = cropRasters(
natArea = natArea,
bioVars = bioVars,
selectVars = v_data
)
)
## perform maxent model
### tabular data
sdm_result <- write_RDS(
path = allPaths$sdmResults,
overwrite = overwrite,
function1 = runMaxnet(selectVars = v_data, rasterData = rasterInputs)
)
## condition to test if model was suscessfull produced.
if (!is.null(sdm_results)) {
print("conservation metrics")
## raster objects
projectsResults <- write_RDS(
path = allPaths$modeledRasters,
overwrite = TRUE,
function1 = rasterResults(sdm_results)
) |>  # unwrap the list of wrapped rasters
lapply( terra::unwrap)
# generate additional
aucMetrics <- write_CSV(
path = allPaths$aucMetrics,
overwrite = overwrite,
function1 = calc_sdm_metrics(
sd_raster = projectsResults$stdev,
auc_scores = sdm_results$AUC
)
)
## generate evaluationTable
evalTable <- write_CSV(
path = allPaths$evalTablePath,
overwrite = overwrite,
function1 = evaluateTable(sdm_result = sdm_results)
)
## generate threshold rasters
thres <- write_Rast(
path = allPaths$thresPath,
overwrite = overwrite,
function1 = generateThresholdModel(
evalTable = evalTable,
rasterResults = projectsResults
)
)
# edits for riparian
# thres <- terra::crop(thres, natArea)
# terra::writeRaster(x = thres, filename = allPaths$thresPath, overwrite = TRUE )
## crop GA50 to threshold area
g_bufferCrop <- write_Rast(
path = allPaths$g50_bufferPath,
overwrite = overwrite,
function1 = cropG_Buffer(ga50 = g_buffer, thres = thres)
)
# insitu
## srsin
srsin <- write_CSV(
path = allPaths$srsinPath,
overwrite = overwrite,
function1 = srs_insitu(
occuranceData = sp1,
thres = thres,
protectedArea = protectedAreas
)
)
## ersin
ersin <- write_CSV(
path = allPaths$ersinPath,
overwrite = overwrite,
function1 = ers_insitu(
occuranceData = sp1,
nativeArea = natArea,
protectedArea = protectedAreas,
thres = thres,
rasterPath = allPaths$ersinRast
)
)
## grsin
grsin <- write_CSV(
path = allPaths$grsinPath,
overwrite = overwrite,
function1 = grs_insitu(
occuranceData = sp1,
protectedArea = protectedAreas,
thres = thres
)
)
## fcsin
fcsin <- write_CSV(
path = allPaths$fcsinPath,
overwrite = overwrite,
function1 = fcs_insitu(
srsin = srsin,
grsin = grsin,
ersin = ersin,
noModel = FALSE
)
)
#exsitu
##ersex
ersex <- write_CSV(
path = allPaths$ersexPath,
overwrite = TRUE,
function1 = ers_exsitu(
speciesData = sp1,
thres = thres,
natArea = natArea,
ga50 = g_bufferCrop,
rasterPath = allPaths$ersexRast
)
)
##grsex
grsex <- write_CSV(
path = allPaths$grsexPath,
overwrite = overwrite,
function1 = grs_exsitu(
speciesData = sp1,
ga50 = g_bufferCrop,
thres = thres
)
)
##fcsex
fcsex <- write_CSV(
path = allPaths$fcsexPath,
overwrite = overwrite,
function1 = fcs_exsitu(
srsex = srsex,
grsex = grsex,
ersex = ersex,
noModel = FALSE
)
)
#combined measure
fcsCombined <- write_CSV(
path = allPaths$fcsCombinedPath,
overwrite = TRUE,
function1 = fcs_combine(fcsin = fcsin, fcsex = fcsex)
)
#gather features for RMD
# just a helper function to reduce the number of input for the RMD
reportData <- write_RDS(
path = allPaths$summaryDataPath,
overwrite = TRUE,
function1 = grabData(
fscCombined = fcsCombined,
ersex = ersex,
ersin = ersin,
fcsex = fcsex,
fcsin = fcsin,
evalTable = evalTable,
aucMetrics = aucMetrics,
g_bufferCrop = g_bufferCrop,
thres = thres,
projectsResults = projectsResults,
occuranceData = sp1,
v_data = v_data,
g_buffer = g_buffer,
natArea = natArea,
protectedAreas = protectedAreas,
countsData = c1,
variableImportance = allPaths$variablbeSelectPath,
NoModel = FALSE,
modelDataCounts = read_csv(paste0(
allPaths$occurances,
"/modelDataSummary.csv"
))
)
)
# rmd with Model ----------------------------------------------------------
export1 <- paste0(j, "_Summary_fnaFilter")
if (!file.exists(export1)) {
try(
rmarkdown::render(
input = "R2/summarize/singleSpeciesSummary_1k_editsSGCK.Rmd",
output_format = "html_document",
output_dir = p1, # file.path(allPaths$result),
output_file = export1,
params = list(
reportData = reportData
),
envir = new.env(parent = globalenv())
# clean = F,
# encoding = "utf-8"
)
)
}
}
} else {
# end of attempt to model
erroredSpecies$lessThenEight <- c(erroredSpecies$lessThenEight, j)
### need the FCS summary data for the full run summary
## srsin can be calculated for all species with at least one lat lon value
## if no model is present (GRSin and ERSin are NA)
## if no G points are present (srsex, grsex, and ersex are 0)
## if g Points present but no model (srsex is calculated, grsex, and ersex are NA )
# generating a buffer object to represent the threshold model
natAreaV <- terra::vect(natArea)
buffer <- sp1 |>
terra::vect() |>
terra::buffer(width = bufferDist) |>
terra::crop(natAreaV) |>
terra::mask(natAreaV)
# convert to a rast
rastBuff <- terra::crop(templateRast, buffer)
buffer_rs <- terra::rasterize(buffer, rastBuff)
names(buffer_rs) <- "Threshold"
# export this file to use in the full genus summary maps
write_Rast(buffer_rs, path = allPaths$thresPath, overwrite = overwrite)
# try to generate g buffer
g_buffer <- write_Rast(
path = allPaths$ga50Path,
overwrite = overwrite,
function1 = create_buffers(
speciesPoints = sp1,
natArea = natArea,
bufferDist = bufferDist,
templateRast = templateRast
)
)
if (class(g_buffer) == "character") {
g_bufferCrop <- g_buffer
} else {
g_bufferCrop <- g_buffer |> terra::mask(natAreaV)
# export this file to use in the full genus summary maps
write_Rast(
g_buffer,
path = allPaths$g50_bufferPath,
overwrite = overwrite
)
}
speciesShort <- c("Vitis novogranatensis", "Vitis rubriflora")
# # for (i in speciesShort) {
# #   counts <- read_csv(paste0(
# #     "data/Vitis/",
# #     i,
# #     "/run08282025_1k/occurances/counts.csv"
# #   ))
# #   htmlExport <- paste0(
# #     "data/Vitis/speciesSummaryHTML/run08282025_1k/",
# #     i,
# #     "_Summary_fnaFilter.html"
# #   )
# #   #render rmd
# #   if (!file.exists(htmlExport)) {
#
# #     rmarkdown::render(
# #       input = "R2/summarize/summaryDocForNoRecords.Rmd",
# #       output_format = "html_document",
# #       output_dir = "data/Vitis/speciesSummaryHTML/run08282025_1k/", # file.path(allPaths$result),
# #       output_file = paste0(i, "_Summary_fnaFilter"),
# #       params = list(
# #         counts = counts
# #       ),
# #       envir = new.env(parent = globalenv())
# #       # clean = F,
# #       # encoding = "utf-8"
# #     )
# #   }
# # }
srsin <- write_CSV(
path = allPaths$srsinPath,
overwrite = overwrite,
function1 = srs_insitu(
occuranceData = sp1,
thres = buffer_rs,
protectedArea = protectedAreas
)
)
ersin <- write_CSV(
path = allPaths$ersinPath,
overwrite = overwrite,
function1 = ers_insitu(
occuranceData = sp1,
nativeArea = natArea,
protectedArea = protectedAreas,
thres = buffer_rs,
rasterPath = allPaths$ersinRast
)
)
## grsin
grsin <- write_CSV(
path = allPaths$grsinPath,
overwrite = overwrite,
function1 = grs_insitu(
occuranceData = sp1,
protectedArea = protectedAreas,
thres = buffer_rs
)
)
fcsin <- write_CSV(
path = allPaths$fcsinPath,
overwrite = overwrite,
function1 = fcs_insitu(
srsin = srsin,
grsin = grsin,
ersin = ersin,
noModel = FALSE
)
)
##ersex
ersex <- write_CSV(
path = allPaths$ersexPath,
overwrite = TRUE,
function1 = ers_exsitu(
speciesData = sd1,
thres = buffer_rs,
natArea = natArea,
ga50 = g_bufferCrop,
rasterPath = allPaths$ersexRast
)
)
##grsex
grsex <- write_CSV(
path = allPaths$grsexPath,
overwrite = overwrite,
function1 = grs_exsitu(
speciesData = sd1,
ga50 = g_bufferCrop,
thres = buffer_rs
)
)
##fcsex
fcsex <- write_CSV(
path = allPaths$fcsexPath,
overwrite = TRUE,
function1 = fcs_exsitu(
srsex = srsex,
grsex = grsex,
ersex = ersex,
noModel = FALSE,
gPoints = gPoints
)
)
#combined measure
fcsCombined <- write_CSV(
path = allPaths$fcsCombinedPath,
overwrite = TRUE,
function1 = fcs_combine(fcsin = fcsin, fcsex = fcsex)
)
reportData <- write_RDS(
path = allPaths$summaryDataPath,
overwrite = TRUE,
function1 = grabData(
fscCombined = fcsCombined,
ersex = ersex,
fcsex = fcsex,
fcsin = fcsin,
ersin = ersin,
evalTable = NA,
aucMetrics = NA,
g_bufferCrop = g_bufferCrop,
thres = buffer_rs,
projectsResults = NA,
occuranceData = sp1,
v_data = NA,
g_buffer = g_buffer,
natArea = natArea,
protectedAreas = protectedAreas,
countsData = c1,
variableImportance = NA,
NoModel = FALSE,
modelDataCounts = NA
)
)
# # # generate the report with
rmarkdown::render(
input = "R2/summarize/singleSpeciesSummaryBuffer_1k.Rmd",
output_format = "html_document",
output_dir = p1, # file.path(allPaths$result),
output_file = paste0(j, "_Summary_fnaFilter"),
params = list(
reportData = reportData
),
envir = new.env(parent = globalenv())
# clean = F,
# encoding = "utf-8"
)
}
# generate summary html
# this is not working with the 1k data do to size fo the rasters... need to reevaluate
# htmlExport <- paste0(p1, "/", j, "_Summary_fnaFilter.html")
# if (!file.exists(htmlExport)) {
# }
# # block here for testing. I want variable in local environment and don't want them written out.
# # stop()
#
# # remove all reused variables ---------------------------------------------
# rm(c1,sp1,srsex,natArea,g_buffer, ,evalTable,thres)
} # end of species loop
###
# script for transferring report files to the share site
# carverd@colostate.edu
# 20230713
###
pacman::p_load(dplyr,readr)
##################
# vitis specific moves ----------------------------------------------------
folder <- "~/trueNAS/work/vitis2/m"
# vitis SDMS --------------------------------------------------------------
genus <- "Vitis"
modelRun <- "run08282025_1k"
# species
splist <- read_csv("temp/allVitisData082025.csv")|>
dplyr::filter(!is.na(taxon), genus == "Vitis")|>
dplyr::select(taxon)|>
distinct()
# files
files <- list.files("data/Vitis/speciesSummaryHTML/run08282025_1k",full.names = TRUE)
# what species are missing
for(i in splist$taxon){
vals <- grepl(pattern = i, x = files)
if(length(unique(vals)) != 2){
print(i)
}
}
# transfer the files
for(i in files){
print(i)
file.copy(i, folder, overwrite = TRUE)
}
