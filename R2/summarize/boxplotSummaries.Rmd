---
title: Genus/genepool level visualization of species indicator distribution
author: Daniel P. Carver and Colin K. Khoury 
output:
  html_document:
      css: style.css
      toc: true
      toc_float: true
date: "Report generated on `r Sys.Date()`"
params:
  inputData: NA
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
# compile all model data for species 
species <- params$inputData$species
data <- params$inputData$data
names <- params$inputData$names
# change to params$inputData$species
```


```{r echo=FALSE, message=FALSE, warning=FALSE}

# generate the plots then append them to a named list
for(i in seq_along(names$shortName)){
  parameter <- names$shortName[i]
  box1 <- generateBoxPlot(data = data,
                names = names,
                parameter = parameter)
  l2 <- list("temp" = box1)
  names(l2) <- parameter

  if(i == 1){
    plots <- l2
    
  }else{
    plots <- c(plots, l2)
  }
}

```

All plots shown below are generate using all available records. The purple points shown on the figures represent the Germplasm records for the given species. 


## Temperature Related Variables {.tabset}

### Annual mean temperature     

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_01
```

### Mean diurnal temperature range

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_02
```

### Isothermality

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_03
```

### Temperature seasonality (standard deviation)        

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_04
```

### Maximum temperature of warmest month                

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_05
```

### Minimum temperature of coldest month                

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_06
```

### Temperature annual range                            

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_07
```

### Mean temperature of wettest quarter                 

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_08
```

### Mean temperature of driest quarter

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_09
```

### Mean temperature of warmest quarter                 

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_10
```

### Mean temperature of coldest quarter                 

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_11
```

## Precipitation related variables {.tabset}

### Annual precipitation                                

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_12
```

### Precipitation of wettest month                      

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_13
```

### Precipitation of driest month                      

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_14
```

### Precipitation seasonality (coefficient of variation)

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_15
```

### Precipitation of wettest quarter                   

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_16
```

### Precipitation of driest quarter                    

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_17
```

### Precipitation of warmest quarter                   

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_18
```

### Precipitation of coldest quarter                   

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_19
```

## Solar Radiation, Wind, and Topography variables {.tabset}

### srad                                               

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_20
```

### vapr                                               

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_21
```

### wind                                              

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_22
```

### Altitude                                          

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_23
```

### Aspect (North-South)                             

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_24
```

### Aspect (East-West)                                  

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_25
```

### Slope

```{r echo=FALSE, message=FALSE, warning=FALSE}
plots$bio_26
```



## Principal Component Analysis  {.tabset}

```{r echo=FALSE, message=FALSE, warning=FALSE}

library("factoextra")
library("FactoMineR")

# helper function  
visualizeAndSave <- function(pcaplot, title, subtitle, tiltX = FALSE){
  # more direct visualization of the plots 
  p1 <- ggpubr::ggpar(pcaplot,
                title = title,
                subtitle = subtitle,
                legend.title = "Taxon Group",
                legend.position = "top",
                ggtheme = theme_gray()
                )
  p1
  #save result 
  # ggexport(plotlist = p1, 
  #          filename = paste0("outputs/pca/july2024exports/",subtitle,".png"))
           # width = 1200,
           # height = 800,
           # res = 300)
}
```


```{r echo=FALSE, message=FALSE, warning=FALSE}

d2 <- data[,c(30, 3:28)]

attData <- d2 |>
    dplyr::mutate(Taxon = stringr::str_replace_all(string = taxon,
                                                         pattern = "_",
                                                         replace = " ")
  )|>
  dplyr::select(
    Taxon,
    "bio_01","bio_02","bio_03","bio_04","bio_05","bio_06","bio_07","bio_08",
    "bio_09", "bio_10","bio_11","bio_12","bio_13","bio_14","bio_15","bio_16",
    "bio_17","bio_18","bio_19","bio_20", "bio_21","bio_22","bio_23","bio_24",
    "bio_25","bio_26" 
  )
names(attData) <- c("Taxon", names$`Current title`)

# generate the PCA 
pca <- PCA(attData[,-1],scale.unit = TRUE, graph = FALSE)
```

### Eigenvalues 

```{r echo=FALSE, message=FALSE, warning=FALSE}
# eigenvalues/ariance 
eig <- fviz_eig(pca, addlabels = TRUE, ylim = c(0, 50))
visualizeAndSave(pcaplot = eig,
                 title = "Principal Component Analysis- Eigenvalues",
                 subtitle = " ") |> 
    ggplotly(height = 800, width = 1200) 


```

### Correlation Circle

```{r echo=FALSE, message=FALSE, warning=FALSE}


# correlation circle 
var <- get_pca_var(pca)
corCircle <- fviz_pca_var(pca, col.var = "black")
visualizeAndSave(pcaplot = corCircle,
                 title = "Principal Component Analysis - Correlation circle",
                 subtitle = "") |>
  ggplotly(height = 800, width = 1200) 


```

### Quality of Representation 

```{r echo=FALSE, message=FALSE, warning=FALSE}
# quality of representation 
fviz_cos2(pca, choice = "var", axes = 1:2)+
  theme(axis.text.x = element_text(angle = 75))+
  ggtitle("Principal Component Analysis - quality of representation")

```

### Contribution of Variables 

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(gridExtra)
# contributino of variables 
# Contributions of variables to PC1
c1 <- fviz_contrib(pca, choice = "var", axes = 1, top = 10) + 
  theme(axis.text.x = element_text(angle = 75))+
  ggtitle("Contribution of Variables Dim-1")

# Contributions of variables to PC2
c2 <- fviz_contrib(pca, choice = "var", axes = 1, top = 10) + 
  theme(axis.text.x = element_text(angle = 75))+
  ggtitle("Contribution of Variables Dim-2")


grid.arrange(c1, c2, ncol=2)

```

### Ellipse

```{r echo=FALSE, message=FALSE, warning=FALSE}
# pca elispe with groups 
pcaEllipse <- fviz_pca_ind(pca,
             geom.ind = "point", # show points only (nbut not "text")
             col.ind = attData$Taxon, # color by groups
             addEllipses = TRUE, # Concentration ellipses
             mean.point = FALSE,
             legend.title = "Taxon Groups"
)
visualizeAndSave(pcaplot = pcaEllipse,
                 title = "Principal Component Analysis - Ellipse",
                 subtitle = "") |>
  ggplotly(height = 800, width = 1200) 

```


### Confidence Ellipses

```{r echo=FALSE, message=FALSE, warning=FALSE}


# Add confidence ellipses
pcaEllipseConfidence <-fviz_pca_ind(pca, 
             geom.ind = "point", 
             col.ind = attData$Taxon, 
             addEllipses = TRUE, 
             ellipse.type = "confidence",
             mean.point = FALSE,
             legend.title = "Groups"
)
visualizeAndSave(pcaplot = pcaEllipseConfidence,
                 title = "Principal Component Analysis - Confidence Ellipse",
                 subtitle = "Confidence Ellipse")|>
  ggplotly(height = 800, width = 1200) 
```


### Convex Hull

```{r echo=FALSE, message=FALSE, warning=FALSE}

# Convex hull
convexHull <- fviz_pca_ind(pca,
                           geom.ind = "point",
             col.ind = attData$Taxon, # color by groups
             addEllipses = TRUE,
             ellipse.type = "convex",
             legend.title = "Groups"
)
visualizeAndSave(pcaplot = convexHull,
                 title = "Principal Component Analysis - Convex Hull Ellipse",
                 subtitle = "")|>
  ggplotly(height = 800, width = 1200) 
```


### Biplot

```{r echo=FALSE, message=FALSE, warning=FALSE}
# biplot with elipse 
biplot <- fviz_pca_biplot(pca, 
                col.ind = attData$Taxon,
                addEllipses = TRUE, 
                label = "var",
                col.var = "black",
                repel = TRUE,
                legend.title = "Species Group") 

visualizeAndSave(pcaplot = biplot,
                 title = "Principal Component Analysis - Biplot",
                 subtitle = "" )|>
  ggplotly(height = 800, width = 1200) 


```




