---
title: Taxon level assessment of occurrence  data
author: Daniel P. Carver and Anne Frances 
output:
  html_document:
      css: style.css
date: "Report generated on `r Sys.Date()`"
params:
  speciesName: NA
---
```{r echo=FALSE, message=FALSE, warning=FALSE}
pacman::p_load("leaflet","data.table", "tidyr", "dplyr","plotly","DT","readr","sf", "tmap",
               "viridis","stringr")
tmap_mode("view")

### function for control number of character after the decimal place 
sigfig <- function(vec, n=3){ 
### function to round values to N significant digits
# input:   vec       vector of numeric
#          n         integer is the required sigfig  
# output:  outvec    vector of numeric rounded to N sigfig

formatC(signif(vec,digits=n), digits=n,format="fg", flag="#") 

} 
# for testing 
speciesName <- "Vitis aestivalis"
# speciesName <- params$speciesName
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
### It be much better to pull out these reference dataset and pass the in as parameters. 


# reading input datasets --------------------------------------------------
## taxonomic reference 
speciesNames <- read_csv(file = "~/Documents/cwr_wildgrapes/data/source_data/taxonomy20230628.csv")
namedFeatures <- read_csv(file = "~/Documents/cwr_wildgrapes/data/source_data/nameList.csv")
## county level reference data
plantsData <- read_csv(file = "~/Documents/cwr_wildgrapes/data/source_data/usda_plants/completeVitis.csv")
bonapData <- read_csv("~/Documents/cwr_wildgrapes/data/source_data/bonap.csv")
natureSeverData <- read_csv("~/Documents/cwr_wildgrapes/data/processed_occurrence/natureServe.csv")
# valid lat long datasets 
observationData <- read_csv("~/Documents/cwr_wildgrapes/data/processed_occurrence/tempDataForCountyMaps_20230920.csv")

#spatial data 
countySHP <- read_sf("~/Documents/cwr_wildgrapes/data/geospatial_datasets/counties/ne_10m_admin_2_counties.gpkg")
stateSHP <- read_sf("~/Documents/cwr_wildgrapes/data/geospatial_datasets/states/ne_10m_admin_1_states_provinces.gpkg")%>%
  dplyr::filter(adm0_a3 == "USA")

speciesList <- dplyr::left_join(x = plantsData, y = namedFeatures, by = c("plant_symbol" =  "Accepted Symbol"))%>%
  dplyr::select( "plant_symbol","Scientific Name")%>%
  distinct()
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
  species <- speciesList[speciesList$`Scientific Name` == speciesName, ]

  # select county data for species 
  speciesSym <- speciesList %>% filter(`Scientific Name` == speciesName)

  plantsData <- plantsData %>% filter(plant_symbol %in% speciesSym$plant_symbol)%>%
    mutate(plantsData = str_sub(geoid, start = 3, end = 7))%>%
    select(plantsData)
  bonap <- bonapData %>% filter(`Scientific Name` == speciesName)%>%
    select(bonap = FIPS)
  natureServe <- natureSeverData[natureSeverData$taxon == speciesName,] |>
    select(natureServe = countyFIPS)

  # combine all the county datasets 
  countyGathered <- countySHP %>%
    select("NAME","NAME_ALT","CODE_LOCAL","REGION")%>%
    mutate(
      plants = case_when(
        CODE_LOCAL %in% plantsData$plantsData ~ "USDA_Plants"),
      bonap = case_when(
        CODE_LOCAL %in% bonap$bonap ~ "bonap"),
      natureServe = case_when(
        CODE_LOCAL %in% natureServe$natureServe ~ "Nature_Serve"),
      allCountySources = paste0(plants," ",bonap," ",natureServe)
    )%>%
  mutate(allCountySources = str_remove_all(allCountySources, pattern = "NA"))%>%
    filter(allCountySources != "  ")
  
  # render occ data
  occData <- observationData[observationData$taxon == species$`Scientific Name`, ] %>%
    dplyr::mutate(type = case_when(
      sampleCategory  == "HUMAN_OBSERVATION" ~ "O",
      TRUE ~ type
    ))

### select states of interset 
# spatial object 
sp1 <- occData %>% 
  dplyr::filter(!is.na(latitude))%>%
  dplyr::filter(iso3!= "CAN")%>%
  dplyr::filter(iso3 != "MEX")%>%
  sf::st_as_sf(coords = c("longitude","latitude"), crs = sf::st_crs(stateSHP))

# select all states from classified data and lat long :FIPS 
state1 <- paste0("US",unique(occData$stateFIPS)) 

state_CountyData <- stateSHP %>%
    filter(iso_3166_2 %in% unique(paste0("US-",countyGathered$REGION)))%>%
    select(name)%>%
    st_drop_geometry()%>% 
    pull()

all_states <- stateSHP %>% 
  dplyr::filter(name %in% state_CountyData | code_local %in% state1)

```



```{r echo=FALSE, message=FALSE, warning=FALSE}
countyState <- countySHP %>% 
  dplyr::filter(REGION %in% all_states$postal)%>%
  dplyr::select(NAME, FIPS, REGION)%>%
  mutate(
    inCountyData = case_when(
      FIPS %in% countyGathered$CODE_LOCAL ~ 1,
      TRUE ~ 0
    )
  )

# filter spatial data based on year recorded 
sp2 <- sp1 %>% 
  dplyr::filter(is.na(yearRecorded) | yearRecorded >= 1970)
older <- sp1 %>% 
  dplyr::filter(yearRecorded < 1970)


for(i in c("O","H","G")){
  sp3 <- sp2[sp2$type == i, ]
  
  
  
  # intersect the county and point data
  df2 <- countyState[unlist(sf::st_intersects(sp3, countyState)), "FIPS"]%>%
    st_drop_geometry()%>%
    group_by(FIPS)%>%
    dplyr::summarise(count = n())
  
  names(df2) <- c("FIPS", as.character(i))
  # join to county feature 
  countyState <- left_join(x = countyState, y = df2, by = "FIPS")
}

# append the older data count 
df2 <- countyState[unlist(sf::st_intersects(older, countyState)), "FIPS"]%>%
    st_drop_geometry()%>%
    group_by(FIPS)%>%
    dplyr::summarise(pre1970 = n())
# join to county feature 
  countyState <- left_join(x = countyState, y = df2, by = "FIPS")
  
# add any record column
countyState <- countyState %>%
  rowwise() %>%
  mutate(anyRecord = sum(inCountyData,O,H,G,pre1970, na.rm = T))


```
## Map of Species Occurrences for `r speciesName`
The map below summarizes all occurrence data at the county level. All counties within a state where are observation was described have been included. It is possible that some of the counties, even though they may not have known occurrences, should be considered habitat for a given taxon. 
Selecting a county will provide the name and summary of the observations within. 

**Blue** color counties are of low priority for review for one of the following reasons: 
- germplasm  sample has been collected from the county after 1970 
- Two herbarium samples have been collected from the county after 1970
- The county was identified by USDA Plants and contains at least one herbarium record. 

**Orange** color counties are of high priority for review for one of the following reasons. 
- All observations were made before 1970
- A single herbarium record was noted after 1970
- Only observational data has been noted within the county. 
- Only defined by USDA Plants

**Grey** color counties are locations where no observations have been noted but an observation has been recorded in the state. This is mostly here so individuals can identify counties worth of inclusion despite the lack of observational data. 


All occurrence  data with latitude and longitude values can be displayed on the map. 

**Orange** color points represent observational data, such as iNaturalist reports. 

**Blue** colored points represent herbarium data

**Green** colored points represents gremplasm sample. Most species do not have any germplasm   records.  


*Probably want something more here to link to 


```{r echo=FALSE, message=FALSE, warning=FALSE}
### county data specifically 
# filter counties based on usda plants data 
  counties <- countyGathered %>%
    mutate(popup = paste0("<b>Name:</b> ",NAME_ALT , 
                         "<br/><b>FIPS:</b> ", CODE_LOCAL,
                         "<br/><b>ID Source(s):</b> ", allCountySources))
  countyPalette <- colorFactor(palette = viridis(6), counties$allCountySources)
 

  
# counties caputered by occurrences and county data 
countyClass <- countyState %>% 
  dplyr::mutate(reviewCounty = case_when(
    G > 0 ~ FALSE, 
    H >= 2 ~ FALSE,
    inCountyData == 1 & H ==1 ~ FALSE,
    anyRecord == 0 ~ FALSE, 
    TRUE ~ TRUE
  ), color = case_when(
      anyRecord >0 & reviewCounty  == TRUE  ~ "#fdae61",
      anyRecord >0 & reviewCounty == FALSE ~ "#74add1",
      anyRecord == 0 ~ "#bdbdbd"
    ),
  popup = paste0(
      "<b>County Name: </b>", NAME,
      "<br/> <b>State: </b>", REGION,
      "<br/> <b> Listed in County Source Data: </b>", inCountyData,
      "<br/> <b> Number of Observations Only Records: </b>", O,
      "<br/> <b> Number of herbarium Records: </b>", H,
      "<br/> <b> Number of germplasm  Records: </b>", G,
      "<br/> <b> Number of Records before 1970: </b>",pre1970  
    )
)

points <- sp1 %>%
  dplyr::mutate(
     popup =paste0( "<b>Data Source: </b>", databaseSource,
    "<br/> <b> Record ID: </b>", sourceUniqueID,
    "<br/> <b> Type: </b>", type,
    "<br/> <b> Year: </b>", yearRecorded,
    "<br/> <b> Location Description: </b>", localityInformation),
    color = case_when(
      type == "O" ~ "#fc8d62",
      type == "H" ~ "#8da0cd",
      type == "G" ~ "#66c2a5"
    ))


# Map 
 
m1 <- leaflet(width = "100%")%>%
    addTiles()%>%
    addMapPane("counties", zIndex = 415) %>%
    addMapPane("points", zIndex = 420)%>%
   addPolygons(data = counties,
                color = ~countyPalette(allCountySources),
                group = "County_Reference",
                label = ~counties$NAME_ALT,
                opacity = 0.4,
                fillOpacity = 0.5,
                popup = ~popup,
                options = pathOptions(pane = "counties"))%>%
    addPolygons(data = countyClass,
                color = "white",
                fillColor =~color,
                popup = ~popup,
                weight = 0.8,
                fillOpacity = 0.6,
                opacity = 0.4,
                group = "counties",
                options = pathOptions(pane = "counties"))%>%
    addCircleMarkers(data =  points %>% filter(type =="O"),
             color = ~color,
             opacity = 1,
             radius = 2,
             stroke = 1,
             popup = ~popup,
             group = "observation",
             options = pathOptions(pane = "points"))%>%
    addCircleMarkers(data = points %>% filter(type =="H"),
             color = ~color,
             opacity = 1,
             radius = 2,
             stroke = 1,
             popup = ~popup,
             group = "herbarium",
             options = pathOptions(pane = "points")
               )%>%
    addCircleMarkers(data = points[points$type =="G",],
             color = ~color,
             opacity = 1,
             radius = 2,
             stroke = 1,
             popup = ~popup,
             group = "germplasm ",
             options = pathOptions(pane = "points")
               )%>%
    addLegend(colors = c("#74add1","#fdae61","#bdbdbd"),
              labels = c("Acceptable County","Review County", "Unknown"),
              group = "counties",
              position = "bottomleft") %>%
    addLegend(position = "bottomright", pal = countyPalette,
              values = counties$allCountySources,
              group = "County_Reference",
              title = "County Reference Data")%>%
  addLayersControl(
      overlayGroups = c("County_Reference","counties","observation", "herbarium", "germplasm "),
      options = layersControlOptions(collapsed = FALSE)
    )%>%
  hideGroup(c("observation","herbarium","germplasm "))

m1



```


## Summary Table of County Data 

The table below display additional attribute data for all the counties with know observation on the the selected taxon. All columns can be filtered and sorted. 

```{r echo=FALSE, message=FALSE, warning=FALSE}
df <- countyClass %>%
  st_drop_geometry()%>%
  dplyr::filter(anyRecord !=0)%>%
  dplyr::select(-color, -popup, -anyRecord)%>%
  dplyr::mutate(inCountyData = case_when(
    inCountyData == 1 ~ TRUE,
    TRUE ~ FALSE
  ))%>%
  dplyr::arrange(REGION)%>%
  rename(
    "County Name" = NAME,
    "GEOID" = "FIPS", 
    "State Abbrevation" = "REGION",
    "County Reference" = "inCountyData",
    "Obersevation Only Records" = O,
    "Heberium Records" = H,
    "germplasm  Records" = G,
    "Pre 1970 Records" = pre1970,
    "Recommend Review" = reviewCounty) 

DT::datatable(df,
              rownames = FALSE,
              filter = c("top")
              )

```

## Summary of Occurrance Data 
This table includes all records not just those with valid latitude and longitude information. 

**Ideally I think we want to link out to this where individual can comment (google doc)** still maybe it make sense to show it all here. 

Not sure what all we want to show here so I'm not adjust the column names etc... 

```{r echo=FALSE, message=FALSE, warning=FALSE}

DT::datatable(occData,
              rownames = FALSE,
              width = "100%",
              filter = c("top")
              )

```

