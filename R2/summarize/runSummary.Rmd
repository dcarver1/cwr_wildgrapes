---
title: Genus/genepool level conservation gap analysis summary
author: Daniel P. Carver and Colin K. Khoury 
output:
  html_document:
      css: style.css
date: "Report generated on `r Sys.Date()`"
params:
  reportData: NA
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
pacman::p_load("leaflet","data.table", "tidyr", "dplyr","plotly","DT")

### function for control number of character after the decimal place 
sigfig <- function(vec, n=3){ 
### function to round values to N significant digits
# input:   vec       vector of numeric
#          n         integer is the required sigfig  
# output:  outvec    vector of numeric rounded to N sigfig

formatC(signif(vec,digits=n), digits=n,format="fg", flag="#") 

} 


testing <- FALSE
# transform data
if(testing==TRUE){
  data <- conservationSummary$summaryData # testing only
  figure1 <- conservationSummary$figure1
  figure2 <- conservationSummary$figure2
  figure3 <- conservationSummary$figure3
  image <- conservationSummary$map
  p1 <- conservationSummary$proAreas
  ga50 <- conservationSummary$ga50Map
  protectCounts <- conservationSummary$protectAreasRichness
}else{
  inputs <- params$reportData
  data <- inputs$summaryData
  figure1 <- inputs$figure1
  figure2 <- inputs$figure2
  figure3 <- inputs$figure3  
  image <- inputs$map
  p1 <- inputs$proAreas
  ga50 <- inputs$ga50Map
  protectCounts <- inputs$protectAreasRichness
}




```

## Conservation gap analysis results 


:::: {style="display: flex;"}

::: {}

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align = 'right', fig.height = 8 } 
#  fig.height= 8
# not all species were showing up with autosize on. Have this set to capture, but need to evaluate how flexable it is. 
heightPerRow <- 35
height <- nrow(data) * heightPerRow
figure1 # |>  layout(autosize = T, width = 800) # might
```
:::

::: {}

```{r echo=FALSE, message=FALSE, warning=FALSE, fig.align = 'right', fig.height = 8 } 
#  fig.height= 8
# not all species were showing up with autosize on. Have this set to capture, but need to evaluate how flexable it is. 
heightPerRow <- 35
height <- nrow(data) * heightPerRow
figure2  # might
```
:::

::::

Clicking the objects at the bottom of the figures will turn on and off elements on the figure.
<br>


## Add second figure based on fig2 from the PNAS paper 

*figure caption text* : Conservation scores per US native CWR (black circles), grouped by conservation assessment type—combined FCSc-mean, FCS ex situ, and FCS in situ — with the average score across taxa displayed as red circles. FCS scores are used to categorize taxa for further conservation action: UP (FCS <25), HP (25 ≤ FCS < 50), MP (50 ≤ FCS < 75), and LP (FCS ≥75).


<br>
<br>
<br>

## Conservation gap analysis results table
```{r  echo=FALSE, message=FALSE, warning=FALSE}
# # alter Counts data for better visualizations
c1 <- data %>%
  select(Taxon = ID, everything()) %>%
  dplyr::mutate(Taxon = stringr::str_replace_all(Taxon, pattern = "_", replacement = " "))
  
c1[,2:12] <- lapply(c1[,2:12], sigfig)

# rename features for the table 
c2 <- c1 |>
  dplyr::select(
    "SRS ex situ" = "SRSex",           
    "GRS ex situ" = "GRSex",   
    "ERS ex situ" = "ERSex",           
    "SRS in situ" = "SRSin",           
    "GRS in situ" = "GRSin",   
    "ERS in situ" = "ERSin",           
    "FCS ex situ" = "FCSex",           
    "FCS in situ" = "FCSin",
    "FCSc min" = "FCSc_min",        
    "FCSc max" = "FCSc_max",        
    "FCSc mean" = "FCSc_mean",   
    "FCSc class min" = "FCSc_min_class",  
    "FCSc class max" = "FCSc_max_class" , 
    "FCSc class mean" = "FCSc_mean_class"
  )

DT::datatable(c2,
              rownames = FALSE,
              class = "compact",
              options = list(pageLength = 10,
                             scrollX='400px'),
              filter = "top")
```
<br>
<br>
<br>


## Map of predicted taxon richness

```{r echo=FALSE, message=FALSE, warning=FALSE}
# core species richness map
r1 <- image
r1[r1==0] <- NA
#distribution palette
distColor <- c("#ffffd4","#fed98e","#fe9929","#d95f0e","#993404")
vals <- unique(values(r1))
# Mean distribution map
meanPal <- colorNumeric(palette = distColor,domain = values(r1), na.color = "transparent")
```


```{r echo=FALSE, message=FALSE, warning=FALSE}
# produce the first map
richness1 <- leaflet(width = "100%", options = leafletOptions(minZoom = 3)) |>
  addTiles() |>
  addRasterImage(x = r1,
                 colors = meanPal,
                 method = "ngb",
                 group = "Species Richness") |>
  addLegend(position = "bottomright",
            color = distColor,
            title = "Species Richness",
            labels = c("1","","","",max(vals,na.rm = TRUE)),
            group = "Mean Distribution Model")

richness1
```
<br>

Predicted taxonomic richness map for assessed taxa, combining `r length(unique(data$ID))` potential distribution models. Darker colors indicate greater numbers of taxa potentially overlapping in the same (∼5 km2) areas.


<br>
<br>
<br>

## Geographic *ex situ* gap richness

Predicted collecting priority hotspots map to resolve geographic gaps in current *ex situ* conservation. The map displays richness of geographic areas within the potential distributions of the assessed taxa that have not been previously collected for *ex situ* conservation (i.e. that are not within 50 km of an existing germplasm collection location). Darker colors indicate greater numbers of taxa potentially overlapping in the same (ca. 5 km2) areas.


```{r echo=FALSE, message=FALSE, warning=FALSE}
g50 <- classify(ga50, cbind(NaN, 0)) |> raster()
exGap <- r1 - g50

#distribution palette
valsexGap <- unique(values(exGap))
# Mean distribution map
exGapPal <- colorNumeric(palette = distColor,
                        domain = values(exGap),
                        na.color = "transparent")



g1 <- leaflet(width = "100%",options = leafletOptions(minZoom = 3))%>%
  addTiles()%>%
  addRasterImage(x = exGap,
                 colors = exGapPal,
                 method = "ngb",
                 group = "Species Richness")%>%
  addLegend(position = "bottomright",
            color = distColor,
            title = "Number of taxa",
            labels = c("1","","","",max(valsexGap,na.rm = TRUE)),
            group = "Mean Distribution Model")

g1
```
<br>
<br>
<br>


## add fig S6 from 2020 PNAS

*figure caption* : Predicted collecting priority hotspots map to resolve ecological gaps in current *ex situ*
conservation. The map displays richness of ecoregions within the potential distributions of the
assessed U.S. wild relatives and wild food plants that have not been previously collected for *ex
situ* conservation, with up to **X** taxa in need of further collecting potentially found in the same
areas. Darker colors indicate greater numbers of taxa potentially overlapping in the same (ca. 5
km2) areas.

<br>
<br>
<br>

## Geographic *in situ* gap richness

Predicted habitat protection priorities map to resolve geographic gaps in current *in situ* conservation. The map displays richness of geographic areas within the potential distributions of the assessed taxa that are outside of current protected areas. Darker colors indicate greater numbers of taxa potentially overlapping in the same (ca. 5 km2) are

```{r echo=FALSE, message=FALSE, warning=FALSE}
# reclass to make the mask of the protect areas features
p2 <- classify(p1, cbind(1, 2))
p2 <- classify(p2, cbind(NaN, 1))
p2 <- classify(p2, cbind(2, NA))

# mask the richness map to protect areas feature
inGap <- raster(p2) * r1

#distribution palette
distColor <- c("#ffffd4","#fed98e","#fe9929","#d95f0e","#993404")
valsInGAP <- unique(values(inGap))
# Mean distribution map
inGapPal <- colorNumeric(palette = distColor,
                        domain = values(inGap),
                        na.color = "transparent")


in1 <- leaflet(width = "100%", options = leafletOptions(minZoom = 3))%>%
  addTiles()%>%
  addRasterImage(x = inGap,
                 colors = inGapPal,
                 method = "ngb",
                 group = "Species Richness")%>%
  addLegend(position = "bottomright",
            color = distColor,
            title = "Number of taxa",
            labels = c("1","","","",max(valsInGAP,na.rm = TRUE)),
            group = "Mean Distribution Model")

in1
```
<br>
<br>
<br>


### Protected areas table
This table lists all protected areas overlapping with the predicted distributions of three or more taxa. The total number of taxa potentially present in the protected area is shown in a column. A full list of protected areas can be found at (add a link once we have a location for hosting the data)

```{r echo=FALSE, message=FALSE, warning=FALSE}
# probably want to process this outside of the rendering of the document. '
pc1 <- protectCounts |>
  dplyr::filter(totalSpecies > 3) |>
  dplyr::arrange(desc(totalSpecies))
DT::datatable(pc1,
              rownames = FALSE,
              class = "compact",
              filter = c("top"))
```

<br>
<br>
<br>


## add fig S8 from 2020 PNAS paper 


*figure caption* :  Predicted habitat protection priorities map to resolve ecological gaps in current *in situ*
conservation. The map displays richness of ecoregions within the potential distributions of the
assessed U.S. wild relatives and wild food plants that are not represented at all within current
protected areas within those potential distributions, with up to 33 taxa inhabiting the same
unprotected lands. Darker colors indicate greater numbers of taxa potentially overlapping in the
same (ca. 5 km2) areas.

<br>
<br>
<br> 
*Note: Score values of zero will not appear on the chart.*


## Definitions of conservation gap analysis scores

### Sampling Representativeness Score (SRS)

**Exsitu** : The Sampling Representativeness Score *ex situ* (SRS ex) calculates the ratio of germplasm accessions (G) available in *ex situ* repositories to reference (H) records for each taxon, making use of all compiled records irrespective of whether they include coordinates.

**Insitu** : The Sampling Representativeness Score *in situ* (SRS in) calculates the proportion of all occurrences of a taxon within its native range that fall within a protected area.

### Geographic Representativeness Score (GRS)

**Exsitu** : The Geographic Representativeness Score *ex situ* (GRS ex situ) uses 50-km-radius buffers created around each G collection coordinate point to estimate geographic areas already well collected within the potential distribution models of each taxon and then calculates the proportion of the potential distribution model covered by these buffers.

**Insitu** : The Geographic Representativeness Score *in situ* (GRS in situ) compares the area (in km2) of the potential distribution model located within protected areas versus the total area of the model.


### Ecological Representativeness Score (ERS)

**Exsitu** : The Ecological Representativeness Score *ex situ* (ERS ex situ) calculates the proportion of terrestrial ecoregions (25) represented within the G buffered areas out of the total number of ecoregions occupied by the potential distribution model.

**Insitu** : The Ecological Representativeness Score *in situ* (ERS in situ) calculates the proportion of ecoregions encompassed within the range of the taxon located inside protected areas to the ecoregions encompassed within the total area of the potential distribution model.


### Final Conservation Score (FCS)

**Ex situ** : The  Final Conservation Score *ex situ* (FCS ex situ) was derived by calculating the average of the three *ex situ* conservation metrics.

**In situ** : The Final Conservation Score *in situ* (FCS in situ) in was derived by calculating the average of the three *in situ* conservation metrics.

**FCSc-mean** : The Combined Final Conservation Score (FCSc-mean) was calculated for each taxon by averaging its final FCS ex situ and FCS in situ scores. Taxa were then categorized with regard to the two conservation strategies as well as in combination, with Urgent Priority (UP) for further conservation action assigned when FCS \<25, High Priority (HP) assigned when 25 ≤ FCS \< 50, Medium Priority (MP) when 50 ≤ FCS \< 75, and Low Priority (LP) when FCS ≥75.

## Definitions of occurrence data categories

**Occurrences** : The total number of records for the taxon that were evaluated for use within the study.

**Occurrences with lat/long**: The total number of records that had a valid latitude and longitude pair and were used for spatial analysis. Non valid latitude longitude pairs included but were not limited to: points not on land masses, and records with only one of the two values present.

**Germplasm Records (G)** : Occurrences in which a living sample (via plant or seed) is present in an *ex situ* conservation system (i.e., botanical garden, seed bank, genebank, etc.). 


**Reference Records (H)** : Occurrences that have a supporting herbarium or other reference record.

**Unique Data Sources**: The number of unique database sources from which occurrences of the taxon were gathered.
