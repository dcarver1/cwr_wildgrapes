---
title: Taxon level modeling, preliminary threat assessment, and conservation gap analysis summary
author: Daniel P. Carver and Colin K. Khoury 
output:
  html_document:
      css: style.css
date: "Report generated on `r Sys.Date()`"
params:
  dataPath: NA
---


```{r echo=FALSE, message=FALSE, warning=FALSE}
pacman::p_load("leaflet","data.table", "tidyr", "dplyr","plotly","DT")

### function for control number of character after the decimal place 
sigfig <- function(vec, n=3){ 
### function to round values to N significant digits
# input:   vec       vector of numeric
#          n         integer is the required sigfig  
# output:  outvec    vector of numeric rounded to N sigfig

formatC(signif(vec,digits=n), digits=n,format="fg", flag="#") 

} 



# transform data
data <- params$dataPath
species <- data$occuranceData$taxon[1]
```

# Conservation Summary 

Plot of the FCS exsitu and FCS insitu data 

```{r echo=FALSE, message=FALSE, warning=FALSE}
d2 <- rbind(data$fcsex, data$fcsin) %>%
  mutate(Category = c("Exsitu", "Insitu"))

d3 <- d2 %>%
  pivot_longer(cols = c("SRS","GRS","ERS","FCS"), names_to = "Metric")

d3$Metric <- factor(d3$Metric, levels = c("SRS","ERS","GRS","FCS"))


plot_ly(d3,
         x = ~Metric,
         y = ~value,
         color = ~Category)%>%
  layout(xaxis = list(title = "", tickangle = 0),
         yaxis = list(title = ""),
         margin = list(b = 100),
         barmode = 'group',
         title = "Exsitu and Insitu Summary Scores")
```

# Summary of Occurance Data 
```{r  echo=FALSE, message=FALSE, warning=FALSE}
# alter Counts data for better visualizations
c1 <- data$countsData %>%
  dplyr::select(Taxon = species,
                'Observations' = totalRecords,
                'Observations with Lat/Long' = totalUseful, 
                'Germplasma Records(G)' = totalGRecords,
                'Herberium Records(H)' = totalHRecords,
                'Unique Data Sources' = numberOfUniqueSources
                )%>%
  dplyr::mutate(Taxon = stringr::str_replace_all(Taxon, pattern = "_", replacement = " "))


DT::datatable(c1,
              rownames = FALSE,
              class = "compact")

```

# Map of Species Data 

```{r echo=FALSE, message=FALSE, warning=FALSE}

# point data
occData <- data$occuranceData %>%
  dplyr::mutate(popup=paste0("<b>Source:</b> ", databaseSource,
                          "<br/><b>Collector Code:</b> ", institute  ,
                          "<br/><b>Collection Type:</b> ", type))
pointColor <- colorFactor(palette = c("#1184D4","#6300F0"), domain = occData$type)
gBuf <- data$g_bufferCrop


# predicted presence map
threshold <- data$binaryMap
thresColor <- colorNumeric(palette = c( "#FFFFFF","#45B320"), domain = values(threshold), na.color = "transparent")

# protected area
protectedArea <- data$protectedArea
protectColor <- colorNumeric(palette = "#B7B648", domain = values(protectedArea), na.color = "transparent")

#buffered G area
gBuf <- data$g_bufferCrop
bufColor <- colorNumeric(palette = "#6300F0", domain = values(gBuf),na.color = "transparent")

#ecoregions
ecoReg <- data$naturalArea
ecoColor <- colorFactor(palette = "Set1",domain = ecoReg$ECO_ID_U)

#distribution palette 
distColor <- c("#ffffd4","#fed98e","#fe9929","#d95f0e","#993404")

# Mean distribution map 
meanDist <- data$projectedResults$mean
meanPal <- colorNumeric(palette = distColor,domain = values(meanDist), na.color = "transparent")
# Median distribution map 
medianDist <- data$projectedResults$median
medianPal <- colorNumeric(palette = distColor,domain = values(medianDist), na.color = "transparent")

# standdard devation map 
stdevDist <- data$projectedResults$stdev
stdevPal <- colorNumeric(palette = distColor,domain = values(stdevDist), na.color = "transparent")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# leaflet Map
## need to got to documentation for specifics on functions https://github.com/Leaflet/Leaflet.markercluster
m1 <- leaflet(width = "100%")%>%
  addTiles()%>%
  addCircleMarkers(data = occData,
             color = ~pointColor(type),
             opacity = 1,
             radius = 1,
             group = "Observations",
             stroke = 1,
             popup = ~popup,
             clusterOptions = markerClusterOptions(
               zoomToBoundsOnClick = FALSE,
               disableClusteringAtZoom = 6,
                showCoverageOnHover = TRUE,
                  spiderLegPolylineOptions = list(weight = 1.5, color = "#08FE62", opacity = 0.5)))%>%
  addLegend(position = "bottomright",
            color = c("#1184D4","#6300F0"),
            labels = c("Herberium", "Germplasm"),
            title = "Observation Type",
            group = "Observations")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
#raster elements
m2 <-m1 %>%
  # threshold 
  addRasterImage(x = raster(threshold), colors = thresColor, group = "Expected Habitat", method = "ngb")%>%
    addLegend(position = "bottomright",
            color = c( "#FFFFFF","#45B320"),
            labels = c("Native Area", "Expected Habitat"),
            title = "Modeled Habitat",
            group = "Expected Habitat")%>%
  #protected area
  addRasterImage(x = raster(protectedArea), colors = protectColor, group = "Protected Area", method = "ngb")%>%
     addLegend(position = "bottomright",
               color = "#B7B648",
            labels = "Protected Area",
            group = "Protected Area")%>%
  #G buf
  addRasterImage(x = raster(gBuf), colors = bufColor, group = "Buffer Germplasm Collections", method = "ngb")%>%
    addLegend(position = "bottomright",
            color = "#6300F0",
            labels = "Buffer Germplasm Collections",
            group = "Buffer Germplasm Collections")%>%
  #mean 
  addRasterImage(x = raster(meanDist), 
                 colors = meanPal,
                 group = "Mean Distribution Model",
                 method = "ngb")%>%
    addLegend(position = "bottomright",
            color = distColor,
            title = "Mean Distribution Model",
            labels = c("low","","","","high"),
            group = "Mean Distribution Model")%>%
  #median 
  addRasterImage(x = raster(medianDist), 
                 colors = medianPal,
                 group = "Median Distribution Model",
                 method = "ngb")%>%
    addLegend(position = "bottomright",
            color = distColor,
            title = "Median Distribution Model",
            labels = c("low","","","","high"),
            group = "Median Distribution Model")%>%
    #stdev 
  addRasterImage(x = raster(stdevDist), 
                 colors = stdevPal,
                 group = "SD of Distribution Model",
                 method = "ngb")%>%
    addLegend(position = "bottomright",
            color = distColor,
            title = "SD of Distribution Model",
            labels = c("low","","","","high"),
            group = "SD of Distribution Model")
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# add polygons
m3 <- m2 %>%
  addPolygons(
    data = ecoReg,
    color = ~ecoColor(ECO_ID_U),
    popup = ~ECO_NAME ,
    group = "Ecoregions")

# add control groups
m3 %>%
  addLayersControl(
    overlayGroups = c("Expected Habitat","Observations","Protected Area",
                      "Buffer Germplasm Collections", "Ecoregions","Mean Distribution Model",
                      "Median Distribution Model","SD of Distribution Model")
  )%>% hideGroup(c("Protected Area","Buffer Germplasm Collections", "Ecoregions",
                   "Mean Distribution Model","Median Distribution Model",
                   "SD of Distribution Model"))


```

### Statistical summary of the model. 

I'd like to slim this down a little. Maybe provide a written description of the parameters that are directly called within the modeling process. Make it something less comprehesive but a bit more digestable. 
Currently I've just dropped all the model training statistic from the table as we are only showing results from the test run. 

```{r, echo=FALSE, eval=TRUE}
# set the sigfig in the table
eval1 <- data$modelEvaluation %>%
  dplyr::select(
    "AUC" = "AUCtest" ,
    "Normalized AUC" = "nAUC",
    "Calibrated AUC" = "cAUC",
    "Threshold Value" = "threshold_test",
    "Sensitivity"  ="sensi_test",
    "Specificity" ="speci_test", 
    "Mathews Correlation" = "matthews.cor_test",
    "Cohen's kappa" = "kappa_index_test" 
    )%>%
  dplyr::mutate_all(.funs = sigfig)


DT::datatable(eval1,
              class = "hover")
```

Additional Text



