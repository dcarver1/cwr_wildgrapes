---
title: Taxon level predicted distribution modeling and conservation gap analysis summary
author: Daniel P. Carver and Colin K. Khoury 
output:
  html_document:
      css: style.css
date: "Report generated on `r Sys.Date()`"
params:
  reportData: NA
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
pacman::p_load("leaflet","data.table", "tidyr", "dplyr","plotly","DT")

### function for control number of character after the decimal place 
sigfig <- function(vec, n=3){ 
### function to round values to N significant digits
# input:   vec       vector of numeric
#          n         integer is the required sigfig  
# output:  outvec    vector of numeric rounded to N sigfig

formatC(signif(vec,digits=n), digits=n,format="fg", flag="#") 

} 
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# transform data
# data <- reportData # testing only
# species <- reportData$countsData$species # testing
data <- params$reportData
species <- data$occuranceData$taxon[1]
printSpecies <- stringr::str_replace_all(string = species, pattern = "_", replacement = " ")
```

# `r printSpecies`

## Occurrence records    

The table below shows a summary of the occurrence records for the taxon. A record “with coordinates” is one that has a complete set of latitude and longitude values associated with it, which could be used for distribution modeling and the conservation gap analysis. In preparation for the conservation gap analyses, we classified each record based on whether it was an existing **ex situ** sample from a genebank or botanic garden (labeled G, as most records were from genebanks), or a reference observation (labeled H, as most of these records were from herbaria).

```{r  echo=FALSE, message=FALSE, warning=FALSE}
# alter Counts data for better visualizations
c1 <- data$countsData %>%
  dplyr::select(
    Taxon = species,
    'Occurrences' = totalRecords,
    'Occurrences with Lat/Long' = totalUseful,
    'Germplasm Records(G)' = totalGRecords,
    'Herbarium Records(H)' = totalHRecords,
    'Unique Data Sources' = numberOfUniqueSources
  ) %>%
  dplyr::mutate(Taxon = stringr::str_replace_all(Taxon, pattern = "_", replacement = " "))


DT::datatable(c1,
              rownames = FALSE,
              class = "compact",
              options = list(dom = 't'))

```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# Generate all the map data
# point data
occData <- data$occuranceData %>%
  dplyr::mutate(
    popup = paste0(
      "<br/><b>Taxon:</b> ",
      taxon,
      "<br/><b>Source:</b> ",
      databaseSource,
      "<br/><b>Collector Code:</b> ",
      institutionCode,
      "<br/><b>Collection Type:</b> ",
      type
    )
  ) |>
  mutate(color = case_when(type == "H" ~ "#1184D4",
                           type == "G" ~ "#6300F0"))


# predicted presence map
threshold <- data$binaryMap
thresColor <- colorNumeric(
  palette = c("#cfcccc70", "#45B320"),
  domain = values(threshold),
  alpha = TRUE,
  na.color = "transparent"
)
# generate a threshold mask
mask1 <- ifel(test = threshold == 1, yes = 1, no = NA)

# protected area
protectedArea <- data$protectedArea
protectColor <-
  colorNumeric(
    palette = "#B7B648",
    domain = values(protectedArea),
    alpha = TRUE,
    na.color = "transparent"
  )
# protected areas mask
proMask <- ifel(test = protectedArea == 1, yes = 1, no = NA)


# insitu map elements
## SRSIN
## total number of observations per cell of the threshold model
webMecOccData <- vect(st_transform(occData, crs = "epsg:3857")) # need to change project
# for the spatial operations with the layer. occData can't have the proj
srs1 <- terra::rasterize(webMecOccData,
                   threshold,
                   fun = "sum",
                   background = 0) |>
  mask(mask1)

totalObsinThres <- sum(values(srs1), na.rm = TRUE)
## total number of observations in protected areas
pro1 <-terra::rasterize(webMecOccData, protectedArea, fun = "sum") |>
  mask(proMask)
totalObsinPro <- sum(values(pro1), na.rm = TRUE)

## GRSIN
## reclassy protected area
proReclass <- ifel(test = is.na(protectedArea),
                   yes = 0,
                   no = 1)
## add values
grs1 <- threshold + proReclass
exPal <- c("#cfcccc80", "#45b320", "#7570b3")
# for some reason passing the vector exPal to the palette arg does not maintain the alpha reference? 
grsinColor <- colorNumeric(palette = c("#cfcccc80", "#45b320", "#7570b3"),
               # purple is a little lighter so the point locations show up clearly
               domain = values(grs1),
               alpha = TRUE,
               na.color = "transparent")
## ERSin
# used on the ERS visualization
allEcos <- data$naturalArea |>
  dplyr::select("ECO_ID_U", "ECO_NAME")
# reproject for spatial operations
webMecAllEcos <- st_transform(allEcos, crs = "epsg:3857")
## showcase ecoregions within the threshold model that do no have a protected area
ers1 <- terra::zonal(proReclass,
               vect(webMecAllEcos),
               fun = "sum",
               na.rm = TRUE)
ers1$ECO_ID_U <- allEcos$ECO_ID_U
ers1$ECO_NAME <- allEcos$ECO_NAME

# determine this ecoregions with model areas -- all the features
n1 <- data$naturalArea %>%
  dplyr::select(ECO_ID_U) %>%
  vect()
# reproject for spatial operations
webMecn1 <- terra::project(x = n1, "epsg:3875")
## zonal Stats to determine overlap between the ecoregions and the threshold model
v1 <- terra::zonal(x = threshold,
               z = n1,
               fun = "sum",
               na.rm = TRUE)# , exact = TRUE)

## reassign the eco id record
v1$ECO_ID_U <- n1$ECO_ID_U
# get a list of ecoregions within the threshold model
ecosInThres <- v1 |>
  dplyr::filter(Threshold > 0) |>
  dplyr::select(ECO_ID_U) |>
  pull()

## ID ecoregions in threshold model with no protected areas
ers2 <- ers1 |>
  dplyr::filter(ECO_ID_U %in% ecosInThres) |>
  dplyr::filter(layer == 0)

if (nrow(ers2) > 0) {
  ## use this list to generate a raster object masked to the
  ersinMap <- n1 |>
    dplyr::filter(ECO_ID_U %in% ers2$ECO_ID_U) |>
    terra::rasterize(y = threshold, "ECO_ID_U") |>
    mask(mask = mask1)
} else{
  ersinMap <- "No values"
}

ecoINPal <- RColorBrewer::brewer.pal(n = length(ers2$ECO_ID_U), name = "Set3")
# this palette requires at least 3 colors
ecoINPal <- ecoINPal[1:length(ers2$ECO_ID_U)]
# define a palette option so that we can set a transparent NA value
ecoINColor <- colorFactor(
  palette = ecoINPal,
  domain = ers2$ECO_ID_U,
  alpha = TRUE,
  na.color =  "#FF000000"
)



# exsitu map elements

#buffered G area
gBuf <- data$g_bufferCrop
if (class(gBuf) != "character") {
  bufColor <-
    colorNumeric(
      palette = "#6300F0",
      domain = values(gBuf),
      na.color = "transparent"
    )
  # GRSex map element
  m1 <- cbind(NaN, 0)
  gbuf2 <- terra::classify(x = gBuf, m1)
  grsexMap <- threshold + gbuf2
  # need to defined this outside of the palette function so it can be called again in the legend
  grsexColor <- colorNumeric(palette = c("#cfcccc80", "#45b320", "#7570b3"),
                 # purple is a little lighter so the point locations show up clearly
                 domain = values(grsexMap),
                 alpha = TRUE,
                 na.color = "transparent")
}


#ecoregions
## grab the missing ecoregions
missingEcos <- data$ersex$missingEcos |> unlist()
## filter the full set
ecoReg <- data$naturalArea |>
  dplyr::filter(ECO_ID_U %in% missingEcos) |>
  dplyr::mutate(ECO_NAME = as.factor(ECO_NAME))

# need to generate a raster object ecoregions, this should be done as part of the modeling process
# then I can pass through a data frame of the ecoregion data, rather the spatial objects

# Rasterize the ecoregions
webMecEcoReg <- st_transform(ecoReg,crs = 3857)
ecoRast <- terra::rasterize(x = webMecEcoReg, y = threshold, "ECO_ID_U")

# apply the mask
ecoRast <- mask(ecoRast, mask1)


# set the palette
# this defines the color used, and can be called in the legend creation
## set 3 has a cap of 12 unique colors
ecoPal <-  RColorBrewer::brewer.pal(n = length(missingEcos), name = "Set3")
ecoPal <- ecoPal[1:length(missingEcos)]

# define a palette option so that we can set a transparent NA value
ecoColor <- colorFactor(palette = c(ecoPal),
                        domain = missingEcos,
                        na.color =  "#FF000000")


#distribution palette
distColor <- c("#ffffd4", "#fed98e", "#fe9929", "#d95f0e", "#993404")
# protect area palette
proColor <- c("#7570b3")
# srsin palete
srsPal1 <-  c("#cfcccc95",
    "#7fcdbb",
    "#41b6c4",
    "#1d91c0",
    "#225ea8",
    "#0c2c84")
srsPal <- colorNumeric(palette = c("#cfcccc95","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#0c2c84"),
               domain = values(srs1),
               alpha = TRUE,
               na.color = "transparent")

# Mean distribution map
meanDist <- data$projectedResults$mean
meanPal <- colorNumeric(palette = distColor,
               domain = values(meanDist),
               na.color = "transparent")
# Median distribution map
medianDist <- data$projectedResults$median
medianPal <-
  colorNumeric(palette = distColor,
               domain = values(medianDist),
               na.color = "transparent")

# standdard devation map
stdevDist <- data$projectedResults$stdev
stdevPal <- colorNumeric(palette = distColor,
               domain = values(stdevDist),
               na.color = "transparent")
```



## Map of Predicted distribution

The map below shows the median, mean, and standard deviation of potential distribution model runs, as well as the predicted presence threshold distribution, The predicted presence threshold distribution was generated by applying a statistically determined threshold value to the median model distribution, and is used in the conservation gap analysis as the potential distribution model. The occurrences used in the modeling process are represented by dots, distinguishing between ex situ germplasm collection (G) and reference sightings (H, for herbaria) records (as available), and the attribute data associated with the points can be viewed by clicking on the dots. The semi-transparent white background reflects the native country-ecoregion area.

Layers can be added to the map using the toggle buttons on the left side. The first layer turned on will be in the bottom position on the map.


```{r echo=FALSE, message=FALSE, warning=FALSE}
# modeled distribution Map
## Add occurrances 
m1 <- leaflet(width = "100%", options = leafletOptions(minZoom = 3)) |>
  addTiles()|>
  addCircleMarkers(data = occData[occData$type=="H",],
             color = ~color,
             opacity = 1,
             radius = 1,
             group = "Occurrences",
             stroke = 1,
             popup = ~popup)%>%
  addLegend(position = "bottomleft",
            color = c("#1184D4","#6300F0"),
            labels = c("Herbarium", "Germplasm"),
            title = "Observation Type",
            group = "Occurrences") |>
  addCircleMarkers(data = occData[occData$type=="G",],
             color = ~color,
             opacity = 1,
             radius = 1,
             group = "Occurrences",
             stroke = 1,
             popup = ~popup)

## add rasters 
m2 <- m1 |> 
  # threshold 
  addRasterImage(x = raster(threshold),
                 colors = thresColor, 
                 group = "Potential distribution model",
                 project = FALSE)|>
    addLegend(position = "bottomright",
            color = c( "#cfcccc","#45B320"),
            labels = c("Native Area", "Potential distribution model"),
            title = "Modeled Habitat",
            group = "Potential distribution model")|>
  #mean 
  addRasterImage(x = meanDist, 
                 colors = meanPal,
                 group = "Mean Distribution Model",
                 project = FALSE)|>
    addLegend(position = "bottomright",
            color = distColor,
            title = "Mean Distribution Model",
            labels = c("low","","","","high"),
            group = "Mean Distribution Model")|>
  #median 
  addRasterImage(x = medianDist, 
                 colors = medianPal,
                 group = "Median Distribution Model",
                 project = FALSE) |>
    addLegend(position = "bottomright",
            color = distColor,
            title = "Median Distribution Model",
            labels = c("low","","","","high"),
            group = "Median Distribution Model")|>
    #stdev 
  addRasterImage(x = stdevDist, 
                 colors = stdevPal,
                 group = "SD of Distribution Model",
                 project = FALSE)|>
    addLegend(position = "bottomright",
            color = distColor,
            title = "SD of Distribution Model",
            labels = c("low","","","","high"),
            group = "SD of Distribution Model")

## Add control layers 
m3 <- m2 |>
  addLayersControl(position = "topleft", options = list(collapsed = FALSE,
                                                        autoZIndex = FALSE),
    overlayGroups = c("Potential distribution model","Occurrences",
                      "Mean Distribution Model",
                      "Median Distribution Model",
                      "SD of Distribution Model"))|> 
  hideGroup(c("Mean Distribution Model",
                  "Median Distribution Model",
                  "SD of Distribution Model"))
m3 
```

# Exsitu Gap Analysis 

The table below shows the ex situ conservation gap analysis summary. The sampling representativeness score ex situ (SRSex) calculates the ratio of germplasm accessions (G) available in ex situ repositories to reference (H) records for each taxon, making use of all compiled records, regardless of whether they include coordinates. The geographical representativeness score ex situ (GRSex) uses buffers of 50 km radius created around each G collection coordinate point to estimate geographic areas already well collected within the distribution models of each taxon, and then calculates the proportion of the distribution model covered by these buffers. The ecological representativeness score ex situ (ERSex) calculates the proportion of terrestrial ecoregions represented within the G buffered areas out of the total number of ecoregions occupied by the distribution model. A final conservation score for ex situ (FCSex) was derived by calculating the average of the three ex situ conservation metrics. All of the conservation metrics are on a scale from 0-100, with 0 = poor conservation and 100 = comprehensive protection. The FCSex is used to categorize species, with urgent priority (UP) for further conservation action assigned when FCSex < 25, high priority (HP) where 25 ≤ FCSex < 50, medium priority (MP) where 50 ≤ FCSex < 75, and low priority (LP) for taxa whose FCSex ≥75.

```{r echo=FALSE, message=FALSE, warning=FALSE}
exCounts <- data$countsData |> 
  dplyr::select(species, 
                "Total with coordinates" = totalUseful,
                "Total G with coordinates" = totalGUseful,
                "Total H with Coordinates" = totalHUseful,
                "Total G records" = totalGRecords,
                "Total H records" = totalHRecords)
exScores <- data$fcsex |> 
  dplyr::mutate("SRSex" = sigfig(SRS),
                "GRSex" = sigfig(GRS),
                "ERSex" = sigfig(ERS),
                "FCSex" = sigfig(FCS))|>
  dplyr::select("SRSex","GRSex","ERSex","FCSex")|>
  dplyr::mutate(
    "FCSex priority category" = case_when(
      FCSex >= 75 ~ "LP",
      FCSex >=50 & FCSex < 75 ~ "MP",
      FCSex >=25 & FCSex < 50 ~ "HP",
      FCSex < 25 ~ "UP"
    )
  )
# combine the data
exTables <- bind_cols(exCounts,exScores)
#visualize 
DT::datatable(exTables,
              rownames = FALSE,
              class = "compact")

```

## Map of GRSex and ERSex measures 

The **GRSex** map shows the potential distribution (threshold map), with previous germplasm collection points surrounded by a 50 km buffer overlaid. Only germplasm (G) points are displayed on the map.

0 = Native area (area of ecoregions within countries where taxon has been observed in the field)

1 = Potential distribution

2 = G buffer (area where ex situ conservation is considered to have been accomplished)


The **ERSex** The map below shows ecoregions from which no G occurrences have been collected. The ecoregion extent has been clipped to match the predicted potential distribution of the species. 

There are many cases where the model extent within a unconserved eco region is small(less than 5 cells). Utilize the "All Ecoregions" layer and the ERSex legend to help locate these areas.  


```{r echo=FALSE, message=FALSE, warning=FALSE}
if(exTables$`Total G with coordinates` == 0){ # no G with lat lon 
  # generate the GRSex map
ex2 <- leaflet(width = "100%")|>
  addProviderTiles(providers$Esri.WorldGrayCanvas)|>
  # Outline of all ecoregions
  addPolygons(
    data = allEcos,
    group = "All Ecoregions",
    weight = 2,
    stroke = TRUE,
    fill = TRUE,
    fillOpacity = 0.2,
    popup = allEcos$ECO_NAME,
    color = "#60616050"
  ) 
}else{ # G points with valid lat lon are present
  # generate the GRSex map
ex1 <- leaflet(width = "100%")|>
  addProviderTiles(providers$Esri.WorldGrayCanvas)|>
  #GRSex raster
  addRasterImage(
    x = raster(grsexMap),
    colors = grsexColor,
    group = "GRSex",
    project = FALSE) |>
  #G points
  addCircleMarkers(
    data = occData[occData$type == "G",],
    color = ~ color,
    opacity = 1,
    radius = 1,
    group = "GRSex",
    stroke = 1,
    popup = ~ popup
  ) |>
  #add legend
  addLegend(
    position = "bottomright",
    color = exPal,
    title = "Ex Situ geographical representativeness",
    labels = c("Native Area", "Potential distribution model", "Habitat with 50km buffer"),
    group = "GRSex"
  )
  
# generate the ERSex map
if(ersex$ERS == 100){
  ex2 <- ex1 |>
    # Outline of all ecoregions
  addPolygons(
    data = allEcos,
    group = "All Ecoregions",
    weight = 2,
    stroke = TRUE,
    fill = TRUE,
    fillOpacity = 0.2,
    popup = allEcos$ECO_NAME,
    color = "#60616050"
  ) 
}else{
  ex2 <- ex1 |>
  # Ecoregion Raster Layers
  addRasterImage(raster(ecoRast),
               group = "ERSex",
               colors = ecoColor,
    project = FALSE)|>
  addLegend(colors = ecoPal,
            group = "ERSex",
            labels = ecoReg$ECO_NAME)|>
  # Outline of all ecoregions
  addPolygons(
    data = allEcos,
    group = "All Ecoregions",
    weight = 2,
    stroke = TRUE,
    fill = TRUE,
    fillOpacity = 0.2,
    popup = allEcos$ECO_NAME,
    color = "#60616050"
  ) 
}
}



# add controls for the layout
ex3 <- ex2 |>
  addLayersControl(
    position = "topleft",
    options = list(collapsed = FALSE,
                   autoZIndex = FALSE),
    overlayGroups = c(
      "GRSex",
      "ERSex",
      "All Ecoregions"
    )
  ) |>
  hideGroup(c(
    "ERSex","All Ecoregions"
  ))

## print the map
ex3
```


### Table of Unconserved Ecoregions Exsitu

The table below shows all the ecoregions utilized within the study.

The column `ERSex Gap Ecoregion` denotes if an ecoregion is within the threshold model but does no have a germplasm record within 50km of it. 

The column `Ecoregion in Threshold Model Area` denotes if an ecoregion is within the predicted area of the threshold model. Any ecoregion with a false value for this column contained a valid occurrence records but does not contain any suitable habitat as defined by the model. 
```{r echo=FALSE, message=FALSE, warning=FALSE}

# # process some area measure of missing ecoregions 
### this is going to take a lot of conditional testing so I'm not sure I want it in now.
### with the eco regions visualized properly I think it's ok without. 
# aveCellSize <- mean(values(cellSize(ecoRast,unit="km")))
# misArea <- ecoRast |>
#   terra::freq() |>
#   dplyr::mutate(area = sigfig(count * aveCellSize, n=3))|>
#   dplyr::select(value, area)

# All ecoregions considered
# identify if they
## have modeled habitat
## are within a 50km buffer of a germplasm collection
eco2 <- data$naturalArea |>
  st_drop_geometry() |>
  dplyr::mutate(
    'ERSex Gap Ecoregion' = case_when(ECO_ID_U %in% missingEcos ~ TRUE,
                                      TRUE ~ FALSE),
    'Ecoregion in Threshold Model Area' = case_when(ECO_ID_U %in% ecosInThres ~ TRUE,
                                                    TRUE ~ FALSE)
  ) |>
  # dplyr::left_join(misArea, by = c("ECO_ID_U"="value"))|>
  dplyr::select(
    'ERSex Gap Ecoregion',
    'Ecoregion in Threshold Model Area',
    # "Square KM missing" = area,
    `Unique ID` = "ECO_ID_U",
    `Ecoregion Name` = "ECO_NAME",
    `Source Name` = "SOURCEDATA"
  ) |>
  arrange(desc(`ERSex Gap Ecoregion`), desc(`Ecoregion in Threshold Model Area`))
#visualize
DT::datatable(eco2,
              rownames = FALSE,
              class = "compact")

``` 
# Insitu Gap Analysis 

The table below shows the in situ conservation gap analysis summary. The sampling representativeness score in situ (SRSin) calculates the proportion of all occurrences of a taxon within its predicted distribution that fall within a protected area. The geographical representativeness score in situ (GRSin) compares the area (in km2) of the distribution model located within protected areas versus the total area of the model. The ecological representativeness score in situ (ERSin) calculates the proportion of ecoregions encompassed within the range of the taxon located inside protected areas to the ecoregions encompassed within the total area of the distribution model. A final conservation score for in situ (FCSin) was derived by calculating the average of the three in situ conservation metrics. All of the conservation metrics are on a scale from 0-100, with 0 = poor conservation and 100 = comprehensive protection. The FCSin is used to categorize species, with urgent priority (UP) for further conservation action assigned when FCSin < 25, high priority (HP) where 25 ≤ FCSin < 50, medium priority (MP) where 50 ≤ FCSin < 75, and low priority (LP) for taxa whose FCSin ≥75. 


```{r echo=FALSE, message=FALSE, warning=FALSE}
inCounts <- data$countsData |> 
  dplyr::select(species, 
                "Total with coordinates" = totalUseful,
                "Total G with coordinates" = totalGUseful,
                "Total H with Coordinates" = totalHUseful
                ## need to resolve some questions about the SRSin measure 
                # "Total G records" = totalGRecords,
                # "Total H records" = totalHRecords
                )
inScores <- data$fcsin |> 
  dplyr::mutate("SRSin" = sigfig(SRS),
                "GRSin" = sigfig(GRS),
                "ERSin" = sigfig(ERS),
                "FCSin" = sigfig(FCS),
                "Total occurrances in modeled area" = totalObsinThres,
                "Total occurrance in protected area" = totalObsinPro)|>
  dplyr::select("SRSin","GRSin","ERSin","FCSin")|>
  dplyr::mutate(
    "FCSin priority category" = case_when(
      FCSin >= 75 ~ "LP",
      FCSin >=50 & FCSin < 75 ~ "MP",
      FCSin >=25 & FCSin < 50 ~ "HP",
      FCSin < 25 ~ "UP"
    )
  )
# combine the data
inTables <- bind_cols(inCounts,inScores)
#visualize 
DT::datatable(inTables,
              rownames = FALSE,
              class = "compact")


```

## Map of Insitu Representativeness Scores

```{r echo=FALSE, message=FALSE, warning=FALSE}
uniqueSRSVals <- sort(unique(values(srs1)))

in1 <- leaflet(width = "100%")|>
  addTiles()|>
  # SRSin 
  addRasterImage(
    x = raster(srs1),
    colors = srsPal,
    group = "SRSin",
    project = FALSE)|>
  addLegend(colors = srsPal1,
            group = "SRSin",
            title = "SRSin",
            labels = c(min(uniqueSRSVals),"", "","","",max(uniqueSRSVals)))

## removing for now 2023-11-30 -- not sure what it tells that srsin does not 
# in2 <- in1 |>
#    addRasterImage(
#     x = raster(pro1),
#     colors = proColor,
#     group = "Observation within Protected Areas",
#     project = FALSE
#   )
##GRSin map 
in3 <- in1 |>
  addRasterImage(
    x = raster(grs1),
    colors = grsinColor,
    group = "GRSin",
    project = FALSE
  )|>
  addLegend(colors = exPal,
            group = "GRSin",
            labels = c("Native Area", "Predicted Habit", "Observation within Protected Area"))
## ERS in map 
if(class(ersinMap) != "character"){
  in3 <- in3 |>
  addRasterImage(
    x = raster(ersinMap),
    colors = ecoINPal,
    group = "ERSin",
    project = FALSE
  )|>
    addLegend(colors = ecoINPal,
              group = "ERSin",
              labels = ers2$ECO_NAME)
}


# add control groups 
in3 <- in3|> 
  addLayersControl(
    position = "topleft",
    options = list(collapsed = FALSE,
                   autoZIndex = FALSE),
    overlayGroups = c(
      "SRSin",
      "GRSin",
      "ERSin"))|>
  hideGroup(group = c( "SRSin", "ERSin"))

in3
```
### Table of Unconserved Ecoregions Insitu

```{r echo=FALSE, message=FALSE, warning=FALSE}
# # process some area measure of missing ecoregions 
# if(class(ersinMap) != "character"){
#   aveCellSizeIN <- mean(values(cellSize(ersinMap,unit="km")))
#   misArea <- ersinMap |>
#     terra::freq() |>
#     dplyr::mutate(area = sigfig(count * aveCellSize, n=3))|>
#     dplyr::select(value, area)
# }else{
#  misAreaIn <- data.frame(
#    values= 0,
#    area = 0
#  )
#  
# }s

# All ecoregions considered
# identify if they
## have modeled habitat
## are within a 50km buffer of a germplasm collection
eco3 <- data$naturalArea |>
  st_drop_geometry() |>
  dplyr::mutate(
    'ERSin Gap Ecoregion' = case_when(ECO_ID_U %in% ers2$ECO_ID_U ~ TRUE,
                                      TRUE ~ FALSE),
    'Ecoregion in Threshold Model Area' = case_when(ECO_ID_U %in% ecosInThres ~ TRUE,
                                                    TRUE ~ FALSE)
  ) |>
  # dplyr::left_join(misAreaIn, by = c("ECO_ID_U"= "values"))|>
  dplyr::select(
    'ERSin Gap Ecoregion',
    'Ecoregion in Threshold Model Area',
    # 'Square KM missing' = values,
    `Unique ID` = "ECO_ID_U",
    `Ecoregion Name` = "ECO_NAME",
    `Source Name` = "SOURCEDATA"
  ) |>
  arrange(desc(`ERSin Gap Ecoregion`), desc(`Ecoregion in Threshold Model Area`))
#visualize
DT::datatable(eco3,
              rownames = FALSE,
              class = "compact")

``` 


# Statistical Summary of the Models

Median models across MaxEnt replicates were evaluated using the area under the receiver operating characteristic curve (AUC), the SD of the AUC across replicates, and the proportion of the potential distribution model with an SD of the replicates \>0.15

```{r, echo=FALSE, eval=TRUE}
# set the sigfig in the table
eval1 <- data$modelEvaluation %>%
  dplyr::select(
    "AUC" = "AUCtest" ,
    "Normalized AUC" = "nAUC",
    "Calibrated AUC" = "cAUC",
    "Threshold Value" = "threshold_test",
    "Sensitivity"  = "sensi_test",
    "Specificity" = "speci_test",
    "Mathews Correlation" = "matthews.cor_test",
    "Cohen's kappa" = "kappa_index_test"
  ) %>%
  dplyr::mutate_all(.funs = sigfig)


DT::datatable(eval1,
              class = "hover")
```

<br>

<br>

<br>

<br>

## Conservation Score Figure 

Plot of the exsitu and insitu conservation scores. [Definitions of Conservation Scores]

```{r echo=FALSE, message=FALSE, warning=FALSE,fig.align='right',out.width="100%"}
d2 <- rbind(data$fcsex, data$fcsin) %>%
  mutate(Category = c("Exsitu", "Insitu"))

d3 <- d2 %>%
  pivot_longer(cols = c("SRS","GRS","ERS","FCS"), names_to = "Metric")
# define the combined score for the species 
d3[9, ] <- list(d3$ID[1], d3$FCS_Score[1],"Combined","FCSc",as.numeric(mean(d3$value[4],d3$value[8])))
#
d3$Metric <- factor(d3$Metric, levels = c("SRS","ERS","GRS","FCS","FCSc"))


plot_ly(d3,
         x = ~Metric,
         y = ~value,
         color = ~Category)%>%
  layout(xaxis = list(title = "", tickangle = 0),
         yaxis = list(title = ""),
         margin = list(b = 100),
         barmode = 'group',
         title = list(text = "<b>Conservation Score Summary</b>",
                      pad = list(b = 20, t = 100 )),
         hovermode = 'compare')

```

*Note: Score values of zero will not appear on the chart.*

## Definitions of Conservation Scores

### Sampling Representativeness Score (SRS)

**Insitu** : The sampling representativeness score in situ (SRSin) calculates the proportion of all occurrences of a taxon within its native range that fall within a protected area.

**Exsitu** : The sampling representativeness score ex situ (SRSex) calculates the ratio of germplasm accessions (G) available in ex situ repositories to reference (H) records for each taxon, making use of all compiled records irrespective of whether they include coordinates.

### Geographic Representativeness Score (GRS)

**Insitu** : The GRSin compares the area (in km2) of the distribution model located within protected areas versus the total area of the model.

**Exsitu** : The GRSex uses 50-km-radius buffers created around each G collection coordinate point to estimate geographic areas already well collected within the distribution models of each taxon and then calculates the proportion of the distribution model covered by these buffers.

### Ecological Representativeness Score (ERS)

**Insitu** : The ERSin calculates the proportion of ecoregions encompassed within the range of the taxon located inside protected areas to the ecoregions encompassed within the total area of the distribution model

**Exsitu** : The ERSex calculates the proportion of terrestrial ecoregions (25) represented within the G buffered areas out of the total number of ecoregions occupied by the distribution model.

### Final Representativeness Score (FCS)

**Insitu** : The FCSin was derived by calculating the average of the three in situ conservation metrics.

**Exsitu** : The FCSex was derived by calculating the average of the three ex situ conservation metrics.

**FCSc-mean** : The FCSc-mean was calculated for each taxon by averaging its final FCSex and FCSin scores. Taxa were then categorized with regard to the two conservation strategies as well as in combination, with UP for further conservation action assigned when FCS \<25, HP assigned when 25 ≤ FCS \< 50, MP when 50 ≤ FCS \< 75, and LP when FCS ≥75.

## Definition of Occurrence Data Categories

**Occurrences** : The total number of records for the species that were evaluated for used within the study.

**Occurrences with lat/long**: The total number of records that had a valid latitude and longitude pair and were used for spatial analysis. Non valid latitude longitude pairs included but is not limited to; points not over land masses and records with only one of the two values present.

**Germplasm Records(G)** : Occurrences in which a living sample (via plant or seed) is present in a preservation focused environment (botanical garden, seed bank). These are Occurrences which could protentially produce viable genetic resource information and are therefore evaluated with the suite of exsit focused conservation metrics.

**Herbarium Records(H)** : Occurrences that have a supporting herbarium record.

**Unique Data Sources**: The number of unique data base sources from which Occurrences of the species were gathered.
