---
title: Taxon level predicted distribution modeling and conservation gap analysis summary
author: Daniel P. Carver and Colin K. Khoury 
output:
  html_document:
      css: style.css
date: "Report generated on `r Sys.Date()`"
params:
  reportData: NA
---

```{r echo=FALSE, message=FALSE, warning=FALSE}
pacman::p_load("leaflet","data.table", "tidyr", "dplyr","plotly","DT")

### function for control number of character after the decimal place 
sigfig <- function(vec, n=3){ 
### function to round values to N significant digits
# input:   vec       vector of numeric
#          n         integer is the required sigfig  
# output:  outvec    vector of numeric rounded to N sigfig

formatC(signif(vec,digits=n), digits=n,format="fg", flag="#") 

} 
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
# transform data

testing <- FALSE
if(testing == TRUE){
  data <- reportData # testing only
  species <- reportData$countsData$species # testing
}else{
  data <- params$reportData
  species <- data$occuranceData$taxon[1]
}
printSpecies <- stringr::str_replace_all(string = species, pattern = "_", replacement = " ")
```

# `r printSpecies`

## Occurrence records    

The table below shows a summary of the occurrence records for the taxon. A record “with coordinates” is one that has a complete set of latitude and longitude values associated with it, which could be used for distribution modeling and the conservation gap analysis. In preparation for the conservation gap analyses, we classified each record based on whether it was an existing *ex situ* sample from a genebank or botanic garden (labeled G, as most records were from genebanks), or a reference observation (labeled H, as most of these records were from herbaria).

```{r  echo=FALSE, message=FALSE, warning=FALSE}
# alter Counts data for better visualizations
c1 <- data$countsData %>%
  dplyr::select(
    Taxon = species,
    'Occurrences' = totalRecords,
    'Occurrences with Lat/Long' = totalUseful,
    'Germplasm Records(G)' = totalGRecords,
    'Herbarium Records(H)' = totalHRecords,
    'Unique Data Sources' = numberOfUniqueSources
  ) %>%
  dplyr::mutate(Taxon = stringr::str_replace_all(Taxon, pattern = "_", replacement = " "))


DT::datatable(c1,
              rownames = FALSE,
              class = "compact",
              options = list(dom = 't'))

```


# Statistical Summary of the Models

Median models across MaxEnt replicates were evaluated using the area under the receiver operating characteristic curve (AUC), the SD of the AUC across replicates, and the proportion of the potential distribution model with an SD of the replicates \>0.15

```{r, echo=FALSE, eval=TRUE}
# set the sigfig in the table
eval1 <- data$modelEvaluation %>%
  dplyr::select(
    "AUC" = "AUCtest" ,
    "Normalized AUC" = "nAUC",
    "Calibrated AUC" = "cAUC",
    "Threshold Value" = "threshold_test",
    "Sensitivity"  = "sensi_test",
    "Specificity" = "speci_test",
    "Mathews Correlation" = "matthews.cor_test",
    "Cohen's kappa" = "kappa_index_test"
  ) %>%
  dplyr::mutate_all(.funs = sigfig)


DT::datatable(eval1,
              class = "hover")
```

<br>


```{r echo=FALSE, message=FALSE, warning=FALSE}
# Generate all the map data
# point data
occData <- data$occuranceData %>%
  dplyr::mutate(
    popup = paste0(
      "<br/><b>Taxon:</b> ",
      taxon,
      "<br/><b>Source:</b> ",
      databaseSource,
      "<br/><b>Collector Code:</b> ",
      institutionCode,
      "<br/><b>Collection Type:</b> ",
      type
    )
  ) |>
  mutate(color = case_when(type == "H" ~ "#1184D4",
                           type == "G" ~ "#6300F0"))


# predicted presence map
threshold <- data$binaryMap
thresColor <- colorNumeric(
  palette = c("#cfcccc70", "#45B320"),
  domain = values(threshold),
  alpha = TRUE,
  na.color = "transparent"
)
# generate a threshold mask
mask1 <- ifel(test = threshold == 1, yes = 1, no = NA)

# protected area
protectedArea <- data$protectedArea
protectColor <-
  colorNumeric(
    palette = "#B7B648",
    domain = values(protectedArea),
    alpha = TRUE,
    na.color = "transparent"
  )
# protected areas mask
proMask <- ifel(test = protectedArea == 1, yes = 1, no = NA)


# insitu map elements
## SRSIN
## total number of observations per cell of the threshold model
webMecOccData <- vect(st_transform(occData, crs = "epsg:3857")) # need to change project
# for the spatial operations with the layer. occData can't have the proj
srs1 <- terra::rasterize(webMecOccData,
                   threshold,
                   fun = "sum",
                   background = 0) |>
  mask(mask1)

totalObsinThres <- sum(values(srs1), na.rm = TRUE)
## total number of observations in protected areas
pro1 <-terra::rasterize(webMecOccData, protectedArea, fun = "sum") |>
  mask(proMask)
totalObsinPro <- sum(values(pro1), na.rm = TRUE)

## GRSIN
## reclassy protected area
proReclass <- ifel(test = is.na(protectedArea),
                   yes = 0,
                   no = 1)
## add values
grs1 <- threshold + proReclass
exPal <- c("#cfcccc80", "#45b320", "#7570b3")
# for some reason passing the vector exPal to the palette arg does not maintain the alpha reference? 
grsinColor <- colorNumeric(palette = c("#cfcccc80", "#45b320", "#7570b3"),
               # purple is a little lighter so the point locations show up clearly
               domain = values(grs1),
               alpha = TRUE,
               na.color = "transparent")
## ERSin
# used on the ERS visualization
allEcos <- data$naturalArea |>
  dplyr::select("ECO_ID_U", "ECO_NAME")
# reproject for spatial operations
webMecAllEcos <- st_transform(allEcos, crs = "epsg:3857")
## showcase ecoregions within the threshold model that do no have a protected area
ers1 <- terra::zonal(proReclass,
               vect(webMecAllEcos),
               fun = "sum",
               na.rm = TRUE)
ers1$ECO_ID_U <- allEcos$ECO_ID_U
ers1$ECO_NAME <- allEcos$ECO_NAME

# determine this ecoregions with model areas -- all the features
n1 <- data$naturalArea %>%
  dplyr::select(ECO_ID_U) %>%
  vect()
# reproject for spatial operations
webMecn1 <- terra::project(x = n1, "epsg:3875")
## zonal Stats to determine overlap between the ecoregions and the threshold model
v1 <- terra::zonal(x = threshold,
               z = n1,
               fun = "sum",
               na.rm = TRUE)# , exact = TRUE)

## reassign the eco id record
v1$ECO_ID_U <- n1$ECO_ID_U
# get a list of ecoregions within the threshold model
ecosInThres <- v1 |>
  dplyr::filter(Threshold > 0) |>
  dplyr::select(ECO_ID_U) |>
  pull()

## ID ecoregions in threshold model with no protected areas
ers2 <- ers1 |>
  dplyr::filter(ECO_ID_U %in% ecosInThres) |>
  dplyr::filter(layer == 0)

if(nrow(ers2) > 0) {
  ## use this list to generate a raster object masked to the
  ersinMap <- n1 |>
    dplyr::filter(ECO_ID_U %in% ers2$ECO_ID_U) |>
    terra::rasterize(y = threshold, "ECO_ID_U") |>
    mask(mask = mask1)
} else{
  ersinMap <- "No values"
}

ecoINPal <- RColorBrewer::brewer.pal(n = length(ers2$ECO_ID_U), name = "Set3")
# this palette requires at least 3 colors
ecoINPal <- ecoINPal[1:length(ers2$ECO_ID_U)]
# define a palette option so that we can set a transparent NA value
ecoINColor <- colorFactor(
  palette = ecoINPal,
  domain = ers2$ECO_ID_U,
  alpha = TRUE,
  na.color =  "#FF000000"
)



# exsitu map elements

#buffered G area
gBuf <- data$g_bufferCrop
if (class(gBuf) != "character" & data$fcsex$GRS != 0) {
  bufColor <-
    colorNumeric(
      palette = "#6300F0",
      domain = values(gBuf),
      na.color = "transparent"
    )
  # GRSex map element
  m1 <- cbind(NaN, 0)
  gbuf2 <- terra::classify(x = gBuf, m1)
  grsexMap <- threshold + gbuf2
  # need to defined this outside of the palette function so it can be called again in the legend
  grsexColor <- colorNumeric(palette = c("#cfcccc80", "#45b320", "#7570b3"),
                 # purple is a little lighter so the point locations show up clearly
                 domain = values(grsexMap),
                 alpha = TRUE,
                 na.color = "transparent")
}


#ecoregions
## grab the missing ecoregions
missingEcos <- data$ersex$missingEcos |> unlist()
## filter the full set
ecoReg <- data$naturalArea |>
  dplyr::filter(ECO_ID_U %in% missingEcos) |>
  dplyr::mutate(ECO_NAME = as.factor(ECO_NAME))

# need to generate a raster object ecoregions, this should be done as part of the modeling process
# then I can pass through a data frame of the ecoregion data, rather the spatial objects

# Rasterize the ecoregions
webMecEcoReg <- st_transform(ecoReg,crs = 3857)
ecoRast <- terra::rasterize(x = webMecEcoReg, y = threshold, "ECO_ID_U")

# apply the mask
ecoRast <- mask(ecoRast, mask1)


# set the palette
# this defines the color used, and can be called in the legend creation
## set 3 has a cap of 12 unique colors
ecoPal <-  RColorBrewer::brewer.pal(n = length(missingEcos), name = "Set3")
ecoPal <- ecoPal[1:length(missingEcos)]

# define a palette option so that we can set a transparent NA value
ecoColor <- colorFactor(palette = c(ecoPal),
                        domain = missingEcos,
                        na.color =  "#FF000000")


#distribution palette
distColor <- c("#ffffd4", "#fed98e", "#fe9929", "#d95f0e", "#993404")
# protect area palette
proColor <- c("#7570b3")
# srsin palete
srsPal1 <-  c("#cfcccc95",
    "#7fcdbb",
    "#41b6c4",
    "#1d91c0",
    "#225ea8",
    "#0c2c84")
srsPal <- colorNumeric(palette = c("#cfcccc95","#7fcdbb","#41b6c4","#1d91c0","#225ea8","#0c2c84"),
               domain = values(srs1),
               alpha = TRUE,
               na.color = "transparent")

# Mean distribution map
meanDist <- data$projectedResults$mean
meanPal <- colorNumeric(palette = distColor,
               domain = values(meanDist),
               na.color = "transparent")
# Median distribution map
medianDist <- data$projectedResults$median
medianPal <-
  colorNumeric(palette = distColor,
               domain = values(medianDist),
               na.color = "transparent")

# standdard devation map
stdevDist <- data$projectedResults$stdev
stdevPal <- colorNumeric(palette = distColor,
               domain = values(stdevDist),
               na.color = "transparent")
```



## Map of Predicted distribution

The map below shows the median, mean, and standard deviation of potential distribution model runs, as well as the predicted presence threshold distribution, The predicted presence threshold distribution was generated by applying a statistically determined threshold value to the median model distribution, and is used in the conservation gap analysis as the potential distribution model. The occurrences used in the modeling process are represented by dots, distinguishing between *ex situ* germplasm collection (G) and reference sightings (H, for herbaria) records (as available), and the attribute data associated with the points can be viewed by clicking on the dots. The semi-transparent white background reflects the native country-ecoregion area.

Layers can be added to the map using the toggle buttons on the left side. The first layer turned on will be in the bottom position on the map.


```{r echo=FALSE, message=FALSE, warning=FALSE}
# modeled distribution Map
## Add occurrances 
m1 <- leaflet(width = "100%", options = leafletOptions(minZoom = 3)) |>
  addTiles()|>
  addCircleMarkers(data = occData[occData$type=="H",],
             color = ~color,
             opacity = 1,
             radius = 1,
             group = "Occurrences",
             stroke = 1,
             popup = ~popup)%>%
  addLegend(position = "bottomleft",
            color = c("#1184D4","#6300F0"),
            labels = c("Herbarium", "Germplasm"),
            title = "Observation Type",
            group = "Occurrences") |>
  addCircleMarkers(data = occData[occData$type=="G",],
             color = ~color,
             opacity = 1,
             radius = 1,
             group = "Occurrences",
             stroke = 1,
             popup = ~popup)

## add rasters 
m2 <- m1 |> 
  # threshold 
  addRasterImage(x = raster(threshold),
                 colors = thresColor, 
                 group = "Potential distribution model",
                 project = FALSE)|>
    addLegend(position = "bottomright",
            color = c( "#cfcccc","#45B320"),
            labels = c("Native Area", "Potential distribution model"),
            title = "Modeled Habitat",
            group = "Potential distribution model")|>
  #mean 
  addRasterImage(x = meanDist, 
                 colors = meanPal,
                 group = "Mean Distribution Model",
                 project = FALSE)|>
    addLegend(position = "bottomright",
            color = distColor,
            title = "Mean Distribution Model",
            labels = c("low","","","","high"),
            group = "Mean Distribution Model")|>
  #median 
  addRasterImage(x = medianDist, 
                 colors = medianPal,
                 group = "Median Distribution Model",
                 project = FALSE) |>
    addLegend(position = "bottomright",
            color = distColor,
            title = "Median Distribution Model",
            labels = c("low","","","","high"),
            group = "Median Distribution Model")|>
    #stdev 
  addRasterImage(x = stdevDist, 
                 colors = stdevPal,
                 group = "SD of Distribution Model",
                 project = FALSE)|>
    addLegend(position = "bottomright",
            color = distColor,
            title = "SD of Distribution Model",
            labels = c("low","","","","high"),
            group = "SD of Distribution Model")

## Add control layers 
m3 <- m2 |>
  addLayersControl(position = "topleft", options = list(collapsed = FALSE,
                                                        autoZIndex = FALSE),
    overlayGroups = c("Potential distribution model","Occurrences",
                      "Mean Distribution Model",
                      "Median Distribution Model",
                      "SD of Distribution Model"))|> 
  hideGroup(c("Mean Distribution Model",
                  "Median Distribution Model",
                  "SD of Distribution Model"))
m3 
```

#  *Ex situ* conservation gap analysis 

The table below shows the *ex situ* conservation gap analysis summary. The sampling representativeness score *ex situ* (SRS *ex situ*) calculates the ratio of germplasm accessions (G) available in *ex situ* repositories to reference (H) records for each taxon, making use of all compiled records, regardless of whether they include coordinates. The geographical representativeness score *ex situ* (GRS ex situ) uses buffers of 50 km radius created around each G collection coordinate point to estimate geographic areas already well collected within the distribution models of each taxon, and then calculates the proportion of the distribution model covered by these buffers. The ecological representativeness score *ex situ* (ERS ex situ) calculates the proportion of terrestrial ecoregions represented within the G buffered areas out of the total number of ecoregions occupied by the distribution model. A final conservation score for <u>ex situ</u> (FCS ex situ) was derived by calculating the average of the three *ex situ* conservation metrics. All of the conservation metrics are on a scale from 0-100, with 0 = poor conservation and 100 = comprehensive conservation. The FCS ex situ is used to categorize species, with urgent priority (UP) for further conservation action assigned when FCS ex situ < 25, high priority (HP) where 25 ≤ FCS ex situ < 50, medium priority (MP) where 50 ≤ FCS ex situ < 75, and low priority (LP) for taxa whose FCS ex situ ≥75.

```{r echo=FALSE, message=FALSE, warning=FALSE}
exCounts <- data$countsData |> 
  dplyr::select("Taxon" = species, 
                "Total with coordinates" = totalUseful,
                "Total G records" = totalGRecords,
                "Total G with coordinates" = totalGUseful,
                "Total H records" = totalHRecords,
                "Total H with Coordinates" = totalHUseful)
exScores <- data$fcsex |> 
  dplyr::mutate("SRS ex situ" = sigfig(SRS),
                "GRS ex situ" = sigfig(GRS),
                "ERS ex situ" = sigfig(ERS),
                "FCS ex situ" = sigfig(FCS))|>
  dplyr::select("SRS ex situ","GRS ex situ","ERS ex situ","FCS ex situ")|>
  dplyr::mutate(
    "FCS ex situ priority category" = case_when(
      `FCS ex situ` >= 75 ~ "LP",
      `FCS ex situ` >=50 & `FCS ex situ` < 75 ~ "MP",
      `FCS ex situ` >=25 & `FCS ex situ` < 50 ~ "HP",
      `FCS ex situ` < 25 ~ "UP"
    )
  )
# combine the data
exTables <- bind_cols(exCounts,exScores)
#visualize 
DT::datatable(exTables,
              rownames = FALSE,
              class = "compact",
              options = list(dom = 't'))

```

## Map of GRS ex situ and ERS ex situ conservation gap analysis measures

The **GRS ex situ** map features show the potential distribution model, with previous ex situ germplasm collection points surrounded by a 50 km buffer overlaid. Only germplasm (G) points are displayed on the map.

The **ERS ex situ** map features show ecoregions within the potential distribution model from which no ex situ germplasm collections have been made. The ecoregion extent has been clipped to be within the potential distribution model of the taxon.There are many cases where the ecoregion area within the potential distribution model extent is very small (e.g., less than 5 cells). Utilize the "All ecoregions" layer and the ERS ex situ legend to help locate these areas.  


```{r echo=FALSE, message=FALSE, warning=FALSE}
if(exTables$`Total G with coordinates` == 0){
  # generate the GRSex map
ex2 <- leaflet(width = "100%")|>
  addProviderTiles(providers$Esri.WorldGrayCanvas)|>
  # Outline of all ecoregions
  addPolygons(
    data = allEcos,
    group = "All ecoregions",
    weight = 2,
    stroke = TRUE,
    fill = TRUE,
    fillOpacity = 0.2,
    popup = allEcos$ECO_NAME,
    color = "#60616050"
  ) 
}else{ # G points with valid lat lon are present
  # generate the GRSex map
  ex1 <- leaflet(width = "100%")|>
  addProviderTiles(providers$Esri.WorldGrayCanvas)|>
  #GRSex raster
  addRasterImage(
    x = raster(grsexMap),
    colors = grsexColor,
    group = "GRS ex situ",
    project = FALSE) |>
  #G points
  addCircleMarkers(
    data = occData[occData$type == "G",],
    color = ~ color,
    opacity = 1,
    radius = 1,
    group = "GRS ex situ",
    stroke = 1,
    popup = ~ popup
  ) |>
  #add legend
  addLegend(
    position = "bottomright",
    color = exPal,
    title = "Ex Situ geographical representativeness",
    labels = c("Native country-ecoregion area", "Potential distribution model", "Areas <50km from an ex situ collection"),
    group = "GRS ex situ"
  )
  
# generate the ERSex map
if(ersex$ERS == 100){
  ex2 <- ex1 |>
    # Outline of all ecoregions
  addPolygons(
    data = allEcos,
    group = "All ecoregions",
    weight = 2,
    stroke = TRUE,
    fill = TRUE,
    fillOpacity = 0.2,
    popup = allEcos$ECO_NAME,
    color = "#60616050"
  ) 
}else{
  ex2 <- ex1 |>
  # Ecoregion Raster Layers
  addRasterImage(raster(ecoRast),
               group = "ERS ex situ",
               colors = ecoColor,
    project = FALSE)|>
  addLegend(colors = ecoPal,
            group = "ERS ex situ",
            labels = ecoReg$ECO_NAME) |>
  # Outline of all ecoregions
  addPolygons(
    data = allEcos,
    group = "All ecoregions",
    weight = 2,
    stroke = TRUE,
    fill = TRUE,
    fillOpacity = 0.2,
    popup = allEcos$ECO_NAME,
    color = "#60616050"
  ) 
}
}



# add controls for the layout
ex3 <- ex2 |>
  addLayersControl(
    position = "topleft",
    options = list(collapsed = FALSE,
                   autoZIndex = FALSE),
    overlayGroups = c(
      "GRS ex situ",
      "ERS ex situ",
      "All ecoregions"
    )
  ) |>
  hideGroup(c(
    "ERS ex situ","All ecoregions"
  ))

## print the map
ex3
```


### Table of unsampled ecoregions in *ex situ* conservation


The table below shows all the ecoregions utilized within the study.

The column `ERS ex situ gap ecoregion` denotes (True) if an ecoregion is overlaps with the predicted distribution model but is farther than 50km from any ex situ conservation occurrence.. 

```{r echo=FALSE, message=FALSE, warning=FALSE}

# # process some area measure of missing ecoregions 
### this is going to take a lot of conditional testing so I'm not sure I want it in now.
### with the eco regions visualized properly I think it's ok without. 
# aveCellSize <- mean(values(cellSize(ecoRast,unit="km")))
# misArea <- ecoRast |>
#   terra::freq() |>
#   dplyr::mutate(area = sigfig(count * aveCellSize, n=3))|>
#   dplyr::select(value, area)

# All ecoregions considered
# identify if they
## have modeled habitat
## are within a 50km buffer of a germplasm collection
eco2 <- data$naturalArea |>
  st_drop_geometry() |>
  dplyr::mutate(
    'ERSex Gap Ecoregion' = case_when(ECO_ID_U %in% missingEcos ~ TRUE,
                                      TRUE ~ FALSE)
  ) |>
  # dplyr::left_join(misArea, by = c("ECO_ID_U"="value"))|>
  dplyr::select(
    'ERSex Gap Ecoregion',
    # "Square KM missing" = area,
    `Unique ID` = "ECO_ID_U",
    `Ecoregion Name` = "ECO_NAME",
    `Source Name` = "SOURCEDATA"
  ) |>
  arrange(desc(`ERSex Gap Ecoregion`))
#visualize
DT::datatable(eco2,
              rownames = FALSE,
              class = "compact")

``` 
# *Insitu* conservation gap analysis

The table below shows the *in situ* conservation gap analysis summary. The sampling representativeness score *in situ* (SRS in situ) calculates the proportion of all occurrences of a taxon within its predicted distribution that fall within a protected area. The geographical representativeness score *in situ* (GRS in situ) compares the area (in km2) of the potential distribution model located within protected areas versus the total area of the model. The ecological representativeness score *in situ* (ERS in situ) calculates the proportion of ecoregions encompassed within the range of the taxon located inside protected areas to the ecoregions encompassed within the total area of the potential distribution model. A final conservation score for *in situ* (FCS in) was derived by calculating the average of the three in situ conservation metrics. All of the conservation metrics are on a scale from 0-100, with 0 = poor conservation and 100 = comprehensive conservation. The FCS *in situ* is used to categorize taxa, with urgent priority (UP) for further conservation action assigned when FCS in situ < 25, high priority (HP) where 25 ≤ FCS in situ < 50, medium priority (MP) where 50 ≤ FCS in situ < 75, and low priority (LP) for taxa whose FCS in situ ≥75.

```{r echo=FALSE, message=FALSE, warning=FALSE}

inCounts <- data$countsData |> 
  dplyr::mutate("Total occurrences in protected area" = round(data$countsData$totalUseful * (data$fcsin$SRS/100))) |> 
  dplyr::select("Taxon" = species, 
                "Total occurrences" = totalUseful,
                  "Total occurrences in protected area")
  
inScores <- data$fcsin |> 
  dplyr::mutate("SRS in situ" = sigfig(SRS),
                "GRS in situ" = sigfig(GRS),
                "ERS in situ" = sigfig(ERS),
                "FCS in situ" = sigfig(FCS),
                "Total occurrances in modeled area" = totalObsinThres,
                "Total occurrance in protected area" = totalObsinPro)|>
  dplyr::select("SRS in situ","GRS in situ","ERS in situ","FCS in situ")|>
  dplyr::mutate(
    "FCS in situ priority category" = case_when(
      `FCS in situ` >= 75 ~ "LP",
      `FCS in situ` >=50 & `FCS in situ` < 75 ~ "MP",
      `FCS in situ` >=25 & `FCS in situ` < 50 ~ "HP",
      `FCS in situ` < 25 ~ "UP"
    )
  )
# combine the data
inTables <- bind_cols(inCounts,inScores)
#visualize 
DT::datatable(inTables,
              rownames = FALSE,
              class = "compact",
              options = list(dom = 't'))


```

## Map of *in situ* conservation gap analysis measures
<br>
The SRS in situ feature shows occurrences within the potential distribution that are outside of protected areas. Values are summarized by count per cell. 
<br>
The GRS in situ feature shows the potential distribution, with distribution occurring within existing protected areas highlighted.
<br>
The ERS in situ feature shows the potential distribution, highlighting ecoregions in which no protected areas are present.
<br>


```{r echo=FALSE, message=FALSE, warning=FALSE}
uniqueSRSVals <- sort(unique(values(srs1)))

in1 <- leaflet(width = "100%")|>
  addTiles()|>
  # SRSin 
  addRasterImage(
    x = raster(srs1),
    colors = srsPal,
    group = "SRS in situ",
    project = FALSE)|>
  addLegend(colors = srsPal1,
            group = "SRS in situ",
            title = "SRS in situ",
            labels = c(min(uniqueSRSVals),"", "","","",max(uniqueSRSVals)))

## removing for now 2023-11-30 -- not sure what it tells that srsin does not 
# in2 <- in1 |>
#    addRasterImage(
#     x = raster(pro1),
#     colors = proColor,
#     group = "Observation within Protected Areas",
#     project = FALSE
#   )
##GRSin map 
in3 <- in1 |>
  addRasterImage(
    x = raster(grs1),
    colors = grsinColor,
    group = "GRS in situ",
    project = FALSE
  )|>
  addLegend(colors = exPal,
            group = "GRS in situ",
            labels = c("Background area", "Potential distribution model", "Potential distribution within a protected area"))

## ERS in map 
if(class(ersinMap) != "character"){
  in3 <- in3 |>
  addRasterImage(
    x = raster(ersinMap),
    colors = ecoINPal,
    group = "ERS in situ",
    project = FALSE
  )|>
    addLegend(colors = ecoINPal,
              group = "ERS in situ",
              labels = ers2$ECO_NAME)
}


# add control groups 
in3 <- in3|> 
  addLayersControl(
    position = "topleft",
    options = list(collapsed = FALSE,
                   autoZIndex = FALSE),
    overlayGroups = c(
      "SRS in situ",
      "GRS in situ",
      "ERS in situ"))|>
  hideGroup(group = c( "SRS in situ", "ERS in situ"))

in3
```
### Table of unconserved ecoregions in *in situ* conservation

The table below shows the descriptions of the ecoregions within the potential distribution, with regard to in situ conservation

ERS in situ Gap Ecoregion : If TRUE, this ecoregion contains potential distribution for the taxa but non of that area is within a protected area. 


```{r echo=FALSE, message=FALSE, warning=FALSE}
# All ecoregions considered
# identify if they
## have modeled habitat
## are within a 50km buffer of a germplasm collection
eco3 <- data$naturalArea |>
  st_drop_geometry() |>
  dplyr::mutate(
    'ERS in situ Gap Ecoregion' = case_when(ECO_ID_U %in% ers2$ECO_ID_U ~ TRUE,
                                      TRUE ~ FALSE)
  ) |>
  # dplyr::left_join(misAreaIn, by = c("ECO_ID_U"= "values"))|>
  dplyr::select(
    'ERS in situ Gap Ecoregion',
    # 'Square KM missing' = values,
    `Unique ID` = "ECO_ID_U",
    `Ecoregion Name` = "ECO_NAME",
    `Source Name` = "SOURCEDATA"
  ) |>
  arrange(desc(`ERS in situ Gap Ecoregion`))
#visualize
DT::datatable(eco3,
              rownames = FALSE,
              class = "compact")

``` 



<br>

<br>

<br>

## Conservation Score Figure 

Plot of the exsitu and insitu conservation scores. [Definitions of Conservation Scores]

```{r echo=FALSE, message=FALSE, warning=FALSE,fig.align='right',out.width="100%"}
d2 <- rbind(data$fcsex, data$fcsin) %>%
  mutate(Category = c("Ex situ", "In situ"))|>
  dplyr::select(
    ID,
    "Sampling Representativeness Score" = SRS,
    "Geographic Representativeness Score" = GRS,
    "Ecological Representativeness Score" = ERS,
    "Final Representativeness Score" = FCS,
    "Score Class" = FCS_Score,
    Category
  )

d3 <- d2 %>%
  pivot_longer(cols = c("Sampling Representativeness Score", "Geographic Representativeness Score",
                        "Ecological Representativeness Score", "Final Representativeness Score"), names_to = "Metric")
# define the combined score for the species 
d3[9, ] <- list(d3$ID[1], NA,"Combined conservation score","Final Representativeness Score Combined",as.numeric(mean(c(d3$value[4],d3$value[8]))))

# define the combined score category 
if(d3$value[9] <= 25){
  d3$`Score Class`[9] <- "UP"
}
if(d3$value[9] > 25 & d3$value[9] <= 50){
  d3$`Score Class`[9] <- "HP"
}
if(d3$value[9] > 50 & d3$value[9] <= 75){
  d3$`Score Class`[9] <- "MP"
}
if(d3$value[9] <= 25){
  d3$`Score Class`[9] <- "LP"
}


#
d3$Metric <- factor(d3$Metric, levels = c("Sampling Representativeness Score", "Geographic Representativeness Score",
                        "Ecological Representativeness Score", "Final Representativeness Score", "Final Representativeness Score Combined"))


plot_ly(d3,
         x = ~Metric,
         y = ~value,
         color = ~Category)%>%
  layout(xaxis = list(title = "", tickangle = 45
                      ),
         yaxis = list(title = ""),
         margin = list(b = 100),
         barmode = 'group',
         hovermode = 'compare')

```

*Note: Score values of zero will not appear on the chart.*

## Definitions of Conservation Scores

### Sampling Representativeness Score (SRS)

**Insitu** : The sampling representativeness score in situ (SRS in situ) calculates the proportion of all occurrences of a taxon within its native range that fall within a protected area.

**Exsitu** : The sampling representativeness score *ex situ* (SRS ex situ) calculates the ratio of germplasm accessions (G) available in *ex situ* repositories to reference (H) records for each taxon, making use of all compiled records irrespective of whether they include coordinates.

### Geographic Representativeness Score (GRS)

**Insitu** : The GRS in situ compares the area (in km2) of the distribution model located within protected areas versus the total area of the model.

**Exsitu** : The GRS ex situ uses 50-km-radius buffers created around each G collection coordinate point to estimate geographic areas already well collected within the distribution models of each taxon and then calculates the proportion of the distribution model covered by these buffers.

### Ecological Representativeness Score (ERS)

**Insitu** : The ERS in situ calculates the proportion of ecoregions encompassed within the range of the taxon located inside protected areas to the ecoregions encompassed within the total area of the distribution model

**Exsitu** : The ERS ex situ calculates the proportion of terrestrial ecoregions (25) represented within the G buffered areas out of the total number of ecoregions occupied by the distribution model.

### Final Representativeness Score (FCS)

**Insitu** : The FCS in situ was derived by calculating the average of the three in situ conservation metrics.

**Exsitu** : The FCS ex situ was derived by calculating the average of the three *ex situ* conservation metrics.

**FCSc-mean** : The FCSc-mean was calculated for each taxon by averaging its final FCS ex situ and FCS in situ scores. Taxa were then categorized with regard to the two conservation strategies as well as in combination, with UP for further conservation action assigned when FCS \<25, HP assigned when 25 ≤ FCS \< 50, MP when 50 ≤ FCS \< 75, and LP when FCS ≥75.

## Definition of Occurrence Data Categories

**Occurrences** : The total number of records for the species that were evaluated for used within the study.

**Occurrences with lat/long**: The total number of records that had a valid latitude and longitude pair and were used for spatial analysis. Non valid latitude longitude pairs included but is not limited to; points not over land masses and records with only one of the two values present.

**Germplasm Records(G)** : Occurrences in which a living sample (via plant or seed) is present in a preservation focused environment (botanical garden, seed bank). These are Occurrences which could protentially produce viable genetic resource information and are therefore evaluated with the suite of exsit focused conservation metrics.

**Herbarium Records(H)** : Occurrences that have a supporting herbarium record.

**Unique Data Sources**: The number of unique data base sources from which Occurrences of the species were gathered.
